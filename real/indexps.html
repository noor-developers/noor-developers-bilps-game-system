<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NOOR Game Management System (v6 - Takomillashtirilgan)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <style>
    :root{
      --primary:#6366f1;
      --primary-dark:#4f46e5;
      --success:#10b981;
      --danger:#ef4444;
      --warning:#f59e0b;
      --bg:#0f172a;
      --panel:#1e293b;
      --panel-light:#334155;
      --text:#f1f5f9;
      --text-dim:#94a3b8;
      --border:#475569;
      --shadow:0 8px 30px rgba(0,0,0,0.5);
      --shadow-light:0 4px 15px rgba(0,0,0,0.2);
    }
    
    @keyframes snowflake-fall {
        0% { transform: translateY(-10vh) rotate(0deg); opacity: 0; }
        100% { transform: translateY(100vh) rotate(360deg); opacity: 1; }
    }
    
    .snowflake {
        color: white;
        font-size: 1em;
        font-family: Arial, sans-serif;
        text-shadow: 0 0 1px #000;
        position: absolute;
        width: 15px;
        height: 15px;
        top: -10%;
        z-index: 10000;
        pointer-events: none;
        animation-name: snowflake-fall;
        animation-timing-function: linear;
        animation-duration: 20s; 
        animation-iteration-count: infinite;
    }

    *{box-sizing:border-box;margin:0;padding:0;font-family:'Segoe UI',Tahoma,sans-serif;}
    body{background:var(--bg);color:var(--text);overflow:hidden;height:100vh;display:flex;flex-direction:column;position:relative;}
    
    /* YANGI LOGIN SCREEN */
    .login-screen{position:fixed;inset:0;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);display:flex;align-items:center;justify-content:center;z-index:9999;transition:opacity 0.5s, visibility 0.5s;}
    .login-container{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;padding:20px;width:100%;}
    .login-header{text-align:center;margin-bottom:30px;color:white;}
    .login-header .logo{font-size:3rem;margin-bottom:10px;font-weight:900;text-shadow:0 0 10px rgba(0,0,0,0.3);}
    .login-header h1{font-size:1.5rem;font-weight:300;opacity:0.9;}
    .login-box{background:rgba(255,255,255,0.95);padding:40px;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,0.3);width:100%;max-width:400px;backdrop-filter:blur(10px);}
    .login-form h2{color:#333;margin-bottom:25px;text-align:center;font-weight:600;}
    .input-group{margin-bottom:20px;}
    .input-group input{width:100%;padding:15px;border:2px solid #e2e8f0;border-radius:10px;font-size:1rem;transition:all 0.3s;background:white;}
    .input-group input:focus{border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,0.1);outline:none;}
    .login-btn{width:100%;padding:15px;background:#667eea;color:white;border:none;border-radius:10px;font-size:1.1rem;font-weight:600;cursor:pointer;transition:all 0.3s;}
    .login-btn:hover{background:#5a6fd8;transform:translateY(-2px);box-shadow:0 5px 15px rgba(102,126,234,0.4);}
    .login-footer{margin-top:25px;text-align:center;padding-top:20px;border-top:1px solid #e2e8f0;}
    .login-footer .clock{font-size:1.5rem;font-weight:700;color:#667eea;font-family:'Courier New',monospace;margin-bottom:5px;text-shadow:0 0 5px rgba(102,126,234,0.3);}
    .login-footer .date{font-size:0.9rem;color:#64748b;}

    /* NEW YEAR BANNER */
    .new-year-banner {
        background: linear-gradient(90deg, #ff4e50 0%, #fc913a 50%, #f9d423 100%);
        color: white;
        text-align: center;
        padding: 8px 0;
        font-weight: 700;
        font-size: 1.1rem;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        animation: pulse 1.5s infinite alternate;
    }
    @keyframes pulse {
        from { opacity: 0.9; transform: scaleY(1); }
        to { opacity: 1; transform: scaleY(1.03); }
    }

    /* TOPBAR */
    .topbar{background:var(--panel);padding:15px 25px;display:flex;align-items:center;justify-content:space-between;border-bottom:3px solid var(--border);box-shadow:var(--shadow);position:relative;z-index:100;}
    .logo{font-size:1.8rem;font-weight:900;color:var(--primary);letter-spacing:3px;text-shadow:0 0 5px rgba(99, 102, 241, 0.5);animation: logo-glow 2s infinite alternate;}
    @keyframes logo-glow {
        from { text-shadow: 0 0 5px rgba(99, 102, 241, 0.5); }
        to { text-shadow: 0 0 15px rgba(99, 102, 241, 0.8); }
    }
    .nav{display:flex;gap:10px;}
    .nav button{background:transparent;border:none;color:var(--text);padding:10px 18px;border-radius:8px;cursor:pointer;font-weight:600;transition:all .3s ease-in-out;}
    .nav button:hover{background:var(--panel-light);transform:scale(1.05);}
    .nav button.active{background:var(--primary);color:#fff;box-shadow:0 4px 10px rgba(99, 102, 241, 0.5);transform:scale(1.05);}
    .topbar-right{display:flex;align-items:center;gap:15px;}
    .clock-container{display:flex;flex-direction:column;align-items:center;}
    .clock{font-size:2rem;font-weight:800;color:var(--warning);font-family:'Dank Mono',monospace;text-shadow:0 0 8px rgba(245, 158, 11, 0.6);animation: clock-pulse 1s infinite alternate;}
    @keyframes clock-pulse {
        from { text-shadow: 0 0 8px rgba(245, 158, 11, 0.6); }
        to { text-shadow: 0 0 15px rgba(245, 158, 11, 0.9); }
    }
    .date{font-size:0.9rem;color:var(--text-dim);margin-top:5px;}
    
    /* BALANCE BOXES */
    .balance-group{display:flex;gap:15px;}
    .balance-box{padding:8px 15px;border-radius:10px;font-weight:700;color:#fff;box-shadow:var(--shadow-light);text-align:center;transition:transform 0.3s, box-shadow 0.3s;}
    .balance-box:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,0.3);}
    .balance-total{background:var(--success);color:#fff;}
    .balance-cash{background:#3b82f6;} /* Blue for Cash */
    .balance-transfer{background:#f97316;} /* Orange for Transfer */
    .balance-debt{background:var(--danger);color:#fff;} /* Red for Debt */
    .balance-box div:first-child{font-size:0.8rem;opacity:0.8;}
    .balance-box div:last-child{font-size:1.1rem;}

    .shift-indicator{background:var(--warning);padding:10px 18px;border-radius:10px;font-weight:700;color:#000;box-shadow:var(--shadow-light);transition:all 0.3s;}
    .shift-indicator.open{background:var(--success);color:#fff;animation: shift-glow 2s infinite alternate;}
    @keyframes shift-glow {
        from { box-shadow: 0 0 5px var(--success); }
        to { box-shadow: 0 0 15px var(--success); }
    }
    
    /* MAIN LAYOUT */
    .main-container{flex:1;display:flex;overflow:hidden;}
    .left-panel{width:350px;background:var(--panel);border-right:2px solid var(--border);padding:20px;overflow-y:auto;transition:width 0.3s;}
    .content-area{flex:1;padding:30px;overflow-y:auto;transition:all 0.3s;}
    .right-panel{width:350px;background:var(--panel);border-left:2px solid var(--border);padding:20px;overflow-y:auto;transition:width 0.3s;}
    
    /* LEFT PANEL STATS */
    .notes-section,.stats-section,.debtors-preview{background:var(--panel-light);padding:20px;border-radius:15px;margin-bottom:20px;box-shadow:var(--shadow-light);transition:transform 0.3s, box-shadow 0.3s;}
    .notes-section:hover,.stats-section:hover,.debtors-preview:hover{transform:translateY(-3px);box-shadow:var(--shadow);}
    .section-title{font-size:1.2rem;font-weight:800;color:var(--primary);margin-bottom:15px;display:flex;align-items:center;gap:10px;}
    .notes-section textarea{width:100%;min-height:120px;padding:12px;border:1px solid var(--border);border-radius:10px;background:var(--bg);color:var(--text);resize:vertical;transition:border-color 0.3s, box-shadow 0.3s;}
    .notes-section textarea:focus{border-color:var(--primary);box-shadow:0 0 0 2px rgba(99, 102, 241, 0.3);}
    .stat-item{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px dashed var(--border);font-size:1rem;transition:background 0.3s;}
    .stat-item:hover{background:rgba(255,255,255,0.05);border-radius:5px;}
    .stat-item:last-child{border:none;}
    .stat-value{font-weight:800;color:var(--success);}
    .active-sessions{background:var(--bg);padding:15px;border-radius:10px;margin-top:15px;transition:all 0.3s;}
    .active-sessions:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,0.2);}
    .session-row{display:flex;justify-content:space-between;padding:8px;font-size:0.95rem;border-bottom:1px solid var(--border);transition:background 0.3s;}
    .session-row:hover{background:rgba(255,255,255,0.05);}
    .debtor-row{display:flex;justify-content:space-between;padding:8px;font-size:0.95rem;border-bottom:1px solid var(--border);color:var(--danger);transition:background 0.3s;}
    .debtor-row:hover{background:rgba(255,255,255,0.05);}
    
    /* CONTENT CARDS */
    .game-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(380px,1fr));gap:25px;margin-top:25px;}
    .game-card{background:var(--panel);border:3px solid var(--border);border-radius:20px;padding:25px;position:relative;transition:all .4s;box-shadow:var(--shadow-light);overflow:hidden;}
    .game-card::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.1),transparent);transition:left 0.5s;}
    .game-card:hover::before{left:100%;}
    .game-card:hover{transform:translateY(-5px);box-shadow:var(--shadow);}
    .game-card.vip{border-color:var(--warning);background:linear-gradient(135deg,var(--panel) 0%,rgba(245,158,11,0.15) 100%);}
    .vip-badge{position:absolute;top:15px;right:15px;background:var(--warning);color:#000;padding:6px 15px;border-radius:8px;font-weight:800;font-size:0.9rem;box-shadow:var(--shadow-light);animation: vip-glow 2s infinite alternate;}
    @keyframes vip-glow {
        from { box-shadow: 0 0 5px var(--warning); }
        to { box-shadow: 0 0 15px var(--warning); }
    }
    .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;}
    .card-title{font-size:1.5rem;font-weight:800;color:var(--text);}
    .status-badge{padding:6px 12px;border-radius:8px;font-size:0.9rem;font-weight:700;transition:background 0.3s;}
    .status-free{background:var(--border);color:var(--text-dim);}
    .status-active{background:var(--success);color:#fff;animation: status-glow 1.5s infinite alternate;}
    @keyframes status-glow {
        from { box-shadow: 0 0 5px var(--success); }
        to { box-shadow: 0 0 15px var(--success); }
    }
    .timer-display{font-size:3rem;font-weight:800;color:var(--primary);font-family:'Courier New',monospace;text-align:center;margin:20px 0;animation: timer-flash 1s infinite alternate;border-radius:10px;padding:5px;transition:all 0.3s;}
    .game-card.time-low .timer-display{color:var(--danger);animation: timer-flash-red 0.5s infinite alternate;}
    @keyframes timer-flash {
        from { opacity: 1; }
        to { opacity: 0.8; }
    }
    @keyframes timer-flash-red {
        from { opacity: 1; text-shadow: 0 0 5px var(--danger); }
        to { opacity: 0.7; text-shadow: none; }
    }
    .cost-display{text-align:center;font-size:1.3rem;color:var(--warning);margin:10px 0;font-weight:600;}
    .game-buttons{display:flex;gap:10px;margin-bottom:20px;}
    .btn{padding:12px;border:none;border-radius:10px;cursor:pointer;font-weight:700;transition:all .3s ease-in-out;flex:1;box-shadow:var(--shadow-light);position:relative;overflow:hidden;}
    .btn::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.2),transparent);transition:left 0.5s;}
    .btn:hover::before{left:100%;}
    .btn-primary{background:var(--primary);color:#fff;}
    .btn-success{background:var(--success);color:#fff;}
    .btn-danger{background:var(--danger);color:#fff;}
    .btn-warning{background:var(--warning);color:#000;}
    .btn:hover{opacity:0.9;transform:scale(1.03);box-shadow:0 5px 15px rgba(0,0,0,0.3);}
    .btn:disabled{opacity:0.5;cursor:not-allowed;transform:none;}
    
    /* BAR ITEMS ON CARD */
    .bar-items-list{background:var(--bg);padding:15px;border-radius:10px;max-height:250px;overflow-y:auto;margin-top:15px;border:1px solid var(--border);transition:all 0.3s;}
    .bar-items-list:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,0.2);}
    .bar-item-row{display:flex;justify-content:space-between;align-items:center;padding:8px;border-bottom:1px dashed var(--border);font-size:0.95rem;transition:background 0.3s;}
    .bar-item-row:hover{background:rgba(255,255,255,0.05);}
    .bar-item-row:last-child{border:none;}
    .remove-item{background:var(--danger);color:#fff;border:none;padding:3px 8px;border-radius:6px;cursor:pointer;font-size:0.8rem;transition:transform 0.2s, background 0.3s;}
    .remove-item:hover{transform:scale(1.1);background:#dc2626;}
    .bar-total{background:var(--success);color:#fff;padding:10px;border-radius:8px;text-align:center;font-weight:800;margin-top:10px;transition:all 0.3s;}
    .bar-total:hover{transform:scale(1.02);}
    
    /* RIGHT PANEL - RECEIPTS */
    .receipt-filters{display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap;}
    .filter-btn{background:var(--panel-light);color:var(--text);border:none;padding:10px 15px;border-radius:8px;cursor:pointer;font-size:0.9rem;font-weight:600;transition:all 0.3s;}
    .filter-btn:hover{background:var(--primary-dark);transform:translateY(-2px);}
    .filter-btn.active{background:var(--primary);color:#fff;box-shadow:0 0 10px rgba(99, 102, 241, 0.5);transform:translateY(-2px);}
    .receipt-item{background:var(--panel-light);padding:15px;border-radius:10px;margin-bottom:15px;font-size:0.95rem;border-left:5px solid var(--primary);box-shadow:var(--shadow-light);transition:all 0.3s;}
    .receipt-item:hover{transform:translateY(-3px);box-shadow:var(--shadow);}
    .receipt-header{font-weight:800;color:var(--primary);margin-bottom:10px;font-size:1.1rem;display:flex;justify-content:space-between;align-items:center;}
    .receipt-item.cancelled .receipt-header { color: var(--danger); }
    .receipt-item.cancelled { border-left-color: var(--danger); }
    .receipt-row{display:flex;justify-content:space-between;margin:5px 0;color:var(--text-dim);}
    .receipt-row strong{color:var(--text);}
    .receipt-total{background:var(--success);color:#fff;padding:15px;border-radius:10px;text-align:center;font-weight:800;margin-top:20px;font-size:1.2rem;box-shadow:var(--shadow);transition:all 0.3s;}
    .receipt-total:hover{transform:scale(1.02);}
    .btn-print{background:var(--primary);color:#fff;padding:5px 10px;font-size:0.8rem;border:none;border-radius:5px;cursor:pointer;transition:all 0.3s;}
    .btn-print:hover{background:var(--primary-dark);transform:scale(1.05);}
    
    /* MODAL */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,0.9);display:flex;align-items:center;justify-content:center;z-index:1000;opacity:0;visibility:hidden;transition:opacity .3s, visibility .3s;}
    .modal.show{opacity:1;visibility:visible;}
    .modal-content{background:var(--panel);padding:30px;border-radius:20px;min-width:450px;max-width:700px;max-height:90vh;overflow-y:auto;box-shadow:var(--shadow);transform:scale(0.9);transition:transform 0.3s;animation: modal-appear 0.3s ease-out;}
    @keyframes modal-appear {
        0% { transform: scale(0.8); opacity: 0; }
        100% { transform: scale(1); opacity: 1; }
    }
    .modal.show .modal-content{transform:scale(1);}
    .modal-header{font-size:1.8rem;font-weight:800;color:var(--primary);margin-bottom:25px;text-align:center;}
    .modal-buttons{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px;margin-bottom:20px;}
    .modal-btn{padding:20px;border:2px solid var(--border);background:var(--panel-light);color:var(--text);border-radius:15px;cursor:pointer;font-weight:700;text-align:center;transition:all .3s;position:relative;overflow:hidden;}
    .modal-btn::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.1),transparent);transition:left 0.5s;}
    .modal-btn:hover::before{left:100%;}
    .modal-btn:hover{border-color:var(--primary);background:var(--primary-dark);color:#fff;transform:scale(1.05);}
    .modal-btn.active { /* For payment selection */
        border-color:var(--success);
        background:var(--success);
        color:#fff;
        transform:scale(1.05);
    }
    .modal-close{display:flex;justify-content:center;gap:15px;margin-top:25px;}
    .modal-input{width:100%;padding:15px;border:2px solid var(--border);border-radius:10px;background:var(--bg);color:var(--text);font-size:1.1rem;margin-bottom:20px;transition:border-color 0.3s, box-shadow 0.3s;}
    .modal-input:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(99, 102, 241, 0.3);}
    .modal-text{text-align:center;margin:20px 0;color:var(--text);line-height:1.7;}
    
    /* SETTINGS FORM */
    .form-group{margin-bottom:20px;}
    .form-group label{display:block;margin-bottom:8px;color:var(--text);font-weight:700;font-size:1rem;}
    .form-group input,.form-group textarea{width:100%;padding:12px;border:1px solid var(--border);border-radius:8px;background:var(--bg);color:var(--text);font-size:1rem;transition:border-color 0.3s, box-shadow 0.3s;}
    .form-group input:focus,.form-group textarea:focus{border-color:var(--primary);box-shadow:0 0 0 2px rgba(99, 102, 241, 0.3);}
    .form-group textarea{min-height:120px;resize:vertical;}

    /* BAR GRID */
    .bar-products-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:20px;margin-top:20px;}
    .bar-product-card{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff;padding:25px;border-radius:15px;text-align:center;cursor:pointer;transition:all .3s;box-shadow:var(--shadow-light);position:relative;overflow:hidden;}
    .bar-product-card::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.2),transparent);transition:left 0.5s;}
    .bar-product-card:hover::before{left:100%;}
    .bar-product-card:hover{transform:translateY(-8px) scale(1.05);box-shadow:var(--shadow);}
    .product-name{font-weight:800;font-size:1.2rem;margin-bottom:10px;}
    .product-price{font-size:1rem;opacity:0.9;}
    
    /* HISTORY / LOG TABLE */
    .data-table{width:100%;border-collapse:collapse;margin-top:20px;transition:all 0.3s;}
    .data-table:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,0.2);}
    .data-table th,.data-table td{padding:12px;text-align:left;border-bottom:1px solid var(--border);transition:background 0.3s;}
    .data-table th{background:var(--panel-light);font-weight:800;color:var(--primary);position:sticky;top:0;}
    .data-table tr:hover{background:var(--panel-light);}
    
    /* DEBTORS LIST */
    .debtors-list{margin-top:20px;}
    .debtor-card{background:var(--panel-light);padding:20px;border-radius:15px;margin-bottom:15px;border-left:5px solid var(--danger);box-shadow:var(--shadow-light);transition:all 0.3s;}
    .debtor-card:hover{transform:translateY(-3px);box-shadow:var(--shadow);}
    .debtor-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
    .debtor-name{font-weight:800;color:var(--danger);font-size:1.2rem;}
    .debtor-total{font-weight:800;color:var(--danger);font-size:1.4rem;}
    .debtor-details{background:var(--bg);padding:15px;border-radius:10px;margin:15px 0;font-size:0.9rem;border:1px solid var(--border);transition:all 0.3s;}
    .debtor-details:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,0.2);}
    .debt-item{display:flex;justify-content:space-between;padding:8px;border-bottom:1px dashed var(--border);transition:background 0.3s;}
    .debt-item:hover{background:rgba(255,255,255,0.05);}
    .debtor-actions{display:flex;gap:10px;margin-top:15px;}
    
    /* YANGI: FOYDALANUVCHI QO'SHISH FORMASI */
    #addUserForm{background:var(--panel-light);padding:20px;border-radius:10px;margin-top:20px;border:1px solid var(--border);}
    
    /* SCROLLBAR */
    ::-webkit-scrollbar{width:8px;height:8px;}
    ::-webkit-scrollbar-track{background:var(--bg);}
    ::-webkit-scrollbar-thumb{background:var(--primary);border-radius:4px;transition:background 0.3s;}
    ::-webkit-scrollbar-thumb:hover{background:var(--primary-dark);}
  </style>
</head>
<body>
  
  <div id="snowfallContainer"></div>

  <!-- YANGI LOGIN DIZAYNI -->
  <div class="login-screen" id="loginScreen">
    <div class="login-container">
      <div class="login-header">
        <div class="logo">üé± NOOR</div>
        <h1>Game Management System</h1>
      </div>
      <div class="login-box">
        <div class="login-form">
          <h2>Tizimga kirish</h2>
          <div class="input-group">
            <input type="text" id="loginUsername" placeholder="Foydalanuvchi nomi" />
          </div>
          <div class="input-group">
            <input type="password" id="loginPassword" placeholder="Parol" />
          </div>
          <button class="login-btn" onclick="login()">Kirish</button>
        </div>
        <div class="login-footer">
          <div class="clock" id="loginClock">00:00:00</div>
          <div class="date" id="loginDate">Yakshanba, 01.01.2024</div>
        </div>
      </div>
    </div>
  </div>
  
  <div id="newYearBanner"></div>

  <div class="topbar">
    <div class="logo">üé± NOOR</div>
    <nav class="nav">
      <button class="active" data-page="billiard">Billiard</button>
      <button data-page="playstation">PlayStation</button>
      <button data-page="bar">Bar</button>
      <button data-page="debtors">Qarzdorlar</button>
      <button data-page="history">Tarix</button>
      <button data-page="log">Log</button>
      <button data-page="settings">‚öôÔ∏è Sozlamalar</button>
    </nav>
    <div class="topbar-right">
      <div class="clock-container">
        <div class="clock" id="mainClock">00:00:00</div>
        <div class="date" id="currentDate"></div>
      </div>
      
      <div class="balance-group">
        <div class="balance-box balance-cash">
            <div>üíµ NAQD</div>
            <div id="cashBalance">0 so'm</div>
        </div>
        <div class="balance-box balance-transfer">
            <div>üí≥ O'TKAZMA</div>
            <div id="transferBalance">0 so'm</div>
        </div>
        <div class="balance-box balance-debt">
            <div>üî¥ QARZLAR</div>
            <div id="debtBalance">0 so'm</div>
        </div>
      </div>
      
      <div class="shift-indicator" id="shiftStatus">Smena yopiq</div>
      <button class="btn btn-warning" onclick="toggleShift()" id="shiftBtn">Smena ochish</button>
      <button class="btn btn-danger" onclick="logout()" id="logoutBtn" style="display:none;">Chiqish</button>
    </div>
  </div>

  <div class="main-container">
    <div class="left-panel">
      <div class="notes-section">
        <div class="section-title">üìù Zametka</div>
        <textarea id="notesArea" placeholder="Muhim eslatmalar..."></textarea>
        <button class="btn btn-primary" style="width:100%;margin-top:8px;" onclick="saveNotes()">Saqlash</button>
      </div>
      
      <div class="stats-section">
        <div class="section-title">üìä Faol sessiyalar</div>
        <div class="active-sessions" id="activeSessions">
          <div style="text-align:center;color:var(--text-dim);">Faol sessiya yo'q</div>
        </div>
      </div>
      
      <div class="stats-section">
        <div class="section-title">üíµ Smenada (Jami Tushum)</div>
        <div class="stat-item">
          <span>Billiard-1:</span>
          <span class="stat-value" id="statB1">0 so'm</span>
        </div>
        <div class="stat-item">
          <span>Billiard-2:</span>
          <span class="stat-value" id="statB2">0 so'm</span>
        </div>
        <div class="stat-item">
          <span>PS4 Pro:</span>
          <span class="stat-value" id="statPS4">0 so'm</span>
        </div>
        <div class="stat-item">
          <span>PS5 Slim:</span>
          <span class="stat-value" id="statPS5">0 so'm</span>
        </div>
        <div class="stat-item">
          <span>Bar:</span>
          <span class="stat-value" id="statBar">0 so'm</span>
        </div>
        <div class="stat-item" style="border-top:2px solid var(--primary);padding-top:10px;margin-top:10px;">
          <span style="font-weight:800;">JAMI TUSHUM:</span>
          <span class="stat-value" id="statTotal">0 so'm</span>
        </div>
      </div>
      
      <div class="debtors-preview">
        <div class="section-title">üî¥ Top 10 qarzdorlar</div>
        <div id="topDebtorsList">
          <div style="text-align:center;color:var(--text-dim);">Qarzdor yo'q</div>
        </div>
      </div>
    </div>

    <div class="content-area" id="contentArea"></div>

    <div class="right-panel">
      <div class="section-title">üßæ Cheklar</div>
      <div class="receipt-filters">
        <button class="filter-btn active" data-filter="today" onclick="filterReceipts('today', this)">Bugun</button>
        <button class="filter-btn" data-filter="7days" onclick="filterReceipts('7days', this)">7 kun</button>
        <button class="filter-btn" data-filter="all" onclick="filterReceipts('all', this)">Barchasi</button>
      </div>
      <div class="receipt-filters">
        <button class="filter-btn active" data-type="all" onclick="filterReceiptsByType('all', this)">Barchasi</button>
        <button class="filter-btn" data-type="billiard-1" onclick="filterReceiptsByType('billiard-1', this)">Billiard-1</button>
        <button class="filter-btn" data-type="billiard-2" onclick="filterReceiptsByType('billiard-2', this)">Billiard-2</button>
        <button class="filter-btn" data-type="ps4" onclick="filterReceiptsByType('ps4', this)">PS4</button>
        <button class="filter-btn" data-type="ps5" onclick="filterReceiptsByType('ps5', this)">PS5</button>
        <button class="filter-btn" data-type="bar" onclick="filterReceiptsByType('bar', this)">Bar</button>
      </div>
      <div id="receiptsList"></div>
    </div>
  </div>

  <!-- Modal oynalari -->
  <div class="modal" id="startModal">
    <div class="modal-content">
      <div class="modal-header">‚è±Ô∏è Sessiyani boshlash</div>
      <div class="modal-text" id="startModalTable"></div>
      <div class="modal-buttons">
        <button class="modal-btn" onclick="selectInputType('time')">
          <div style="font-size:2rem;margin-bottom:8px;">‚è∞</div>
          <div>Vaqt bo'yicha (minut)</div>
        </button>
        <button class="modal-btn" onclick="selectInputType('money')">
          <div style="font-size:2rem;margin-bottom:8px;">üí∞</div>
          <div>Pul bo'yicha (so'm)</div>
        </button>
      </div>
      <div class="modal-close">
        <button class="btn btn-danger" onclick="closeModal('startModal')">Yopish</button>
      </div>
    </div>
  </div>
  
  <!-- Qolgan modal oynalari -->
  <div class="modal" id="inputModal">
    <div class="modal-content">
      <div class="modal-header" id="inputModalTitle"></div>
      <input type="number" class="modal-input" id="inputModalValue" placeholder="" />
      <div class="modal-close">
        <button class="btn btn-success" onclick="confirmInput()">Tasdiqlash</button>
        <button class="btn btn-danger" onclick="closeModal('inputModal')">Bekor qilish</button>
      </div>
    </div>
  </div>
  
  <div class="modal" id="paymentModal">
    <div class="modal-content">
      <div class="modal-header" id="paymentModalHeader">üí≥ To'lov</div>
      <div class="modal-text" id="paymentDetails"></div>
      
      <div class="modal-buttons" style="grid-template-columns:1fr 1fr; margin-bottom: 20px;">
        <button class="modal-btn active" id="payBtnCash" onclick="selectPaymentType('cash', this)">üíµ Naqd</button>
        <button class="modal-btn" id="payBtnTransfer" onclick="selectPaymentType('transfer', this)">üí≥ O'tkazma</button>
      </div>
      
      <div class="modal-close" style="display:grid; grid-template-columns: 1fr 1fr; gap: 15px;">
        <button class="btn btn-success" onclick="confirmPayment()" style="grid-column: 1 / -1;">‚úÖ To'lash</button>
        <button class="btn btn-danger" id="paymentModalDebtBtn" onclick="addToDebt()">üî¥ Qarzga</button>
        <button class="btn btn-primary" onclick="closePaymentModal(true)">Bekor qilish</button>
      </div>
    </div>
  </div>
  
  <div class="modal" id="selectDebtorModal">
    <div class="modal-content">
      <div class="modal-header">üî¥ Qarzga yozish</div>
      <div class="modal-text">Mavjud qarzdorlardan birini tanlang yoki yangi qo'shing:</div>
      <div class="modal-buttons" id="existingDebtorsList" style="max-height: 200px; overflow-y: auto; padding-right: 10px;">
        </div>
      <button class="btn btn-primary" style="width:100%; margin-top:15px;" onclick="openNewDebtorModal()">+ Yangi Qarzdor Qo'shish</button>
      <div class="modal-close">
        <button class="btn btn-danger" onclick="closeModal('selectDebtorModal'); openModal('paymentModal');">Orqaga</button>
      </div>
    </div>
  </div>

  <div class="modal" id="newDebtorModal">
    <div class="modal-content">
      <div class="modal-header">üìù Yangi Qarzdor Ismi</div>
      <input type="text" class="modal-input" id="newDebtorName" placeholder="Qarzdor ismini kiriting" />
      <div class="modal-close">
        <button class="btn btn-success" onclick="confirmDebtName(null)">Saqlash</button>
        <button class="btn btn-danger" onclick="closeModal('newDebtorModal'); openModal('selectDebtorModal');">Orqaga</button>
      </div>
    </div>
  </div>
  
  <div class="modal" id="confirmModal">
    <div class="modal-content">
      <div class="modal-header">‚ö†Ô∏è Tasdiqlash</div>
      <div class="modal-text" id="confirmText"></div>
      <div class="modal-close">
        <button class="btn btn-success" onclick="confirmAction()">Ha</button>
        <button class="btn btn-danger" onclick="closeModal('confirmModal')">Yo'q</button>
      </div>
    </div>
  </div>
  
  <div class="modal" id="notificationModal">
    <div class="modal-content">
      <div class="modal-header">‚ÑπÔ∏è Xabar</div>
      <div class="modal-text" id="notificationText"></div>
      <div class="modal-close">
        <button class="btn btn-primary" onclick="closeModal('notificationModal')">OK</button>
      </div>
    </div>
  </div>
  
  <div class="modal" id="transferModal">
    <div class="modal-content">
      <div class="modal-header" style="color:#f97316;">üí≥ O'tkazma ma'lumotlari</div>
      <div class="modal-text">
        <div style="font-weight:700;">Karta raqami:</div>
        <div style="font-size:1.5rem;color:var(--text);" id="transferCardNumber"></div>
      </div>
      <div class="modal-text" style="color:var(--danger);font-weight:700;">
        Iltimos, o'tkazma summasi (<span id="transferAmountDisplay">0</span> so'm) kelib tushganiga ishonch hosil qiling!
      </div>
      <div class="modal-close">
        <button class="btn btn-success" onclick="finalizePayment('transfer')">‚úÖ Tushunarli</button>
      </div>
    </div>
  </div>

  <div class="modal" id="alarmModal">
    <div class="modal-content" style="background:var(--danger);">
      <div class="modal-header" style="color:#fff;">üö® VAQT TUGAYAPTI!</div>
      <div class="modal-text" style="color:#fff;font-size:1.5rem;" id="alarmText"></div>
      <div class="modal-close">
        <button class="btn btn-warning" onclick="closeModal('alarmModal')">OK</button>
      </div>
    </div>
  </div>
  
  <div class="modal" id="barProductModal">
    <div class="modal-content">
      <div class="modal-header">üçπ Kimga sotiladi?</div>
      <div class="modal-buttons" id="barTargetButtons"></div>
      <button class="btn btn-success" style="width:100%;margin-top:10px;" onclick="sellToCustomer()">Mijozga sotish</button>
      <div class="modal-close">
        <button class="btn btn-danger" onclick="closeModal('barProductModal')">Yopish</button>
      </div>
    </div>
  </div>

  <div class="modal" id="settingsPasswordModal">
    <div class="modal-content">
      <div class="modal-header">üîí Sozlamalar paroli</div>
      <input type="password" class="modal-input" id="settingsPasswordInput" placeholder="Parolni kiriting" />
      <div class="modal-close">
        <button class="btn btn-success" onclick="checkSettingsPassword()">Kirish</button>
        <button class="btn btn-danger" onclick="closeModal('settingsPasswordModal')">Bekor qilish</button>
      </div>
    </div>
  </div>
  
  <div class="modal" id="settingsModal">
    <div class="modal-content" style="max-width:750px;">
      <div class="modal-header">‚öôÔ∏è Sozlamalar</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
        <div>
          <h3 style="color:var(--warning);margin-bottom:15px;">Xavfsizlik & Xodim</h3>
          <div class="form-group">
            <label>Sozlamalar paroli (Admin):</label>
            <input type="password" id="settingsPassword" placeholder="Yangi parol (bo'sh qoldiring o'zgartirilmasin)">
          </div>
          <div class="form-group">
            <label>O'tkazma (Transfer) Karta Raqami:</label>
            <input type="text" id="settingsTransferCard" placeholder="1234 1234 1234 1234">
          </div>
          <h3 style="color:#3b82f6;margin-bottom:15px;margin-top:20px;">Foydalanuvchilar (Login - Parol)</h3>
          <div class="form-group">
            <textarea id="usersInput" placeholder="noordev - Noor3112&#10;xodim2 - 1234"></textarea>
          </div>
          
          <!-- YANGI: FOYDALANUVCHI QO'SHISH FORMASI -->
          <div id="addUserForm"></div>
          
        </div>
        <div>
          <h3 style="color:var(--success);margin-bottom:15px;">Narxlar (so'm/soat)</h3>
          <div class="form-group">
            <label>Billiard-1:</label>
            <input type="number" id="priceB1" value="40000">
          </div>
          <div class="form-group">
            <label>Billiard-2:</label>
            <input type="number" id="priceB2" value="40000">
          </div>
          <div class="form-group">
            <label>PlayStation 4 Pro:</label>
            <input type="number" id="pricePS4" value="15000">
          </div>
          <div class="form-group">
            <label>PlayStation 5 Slim:</label>
            <input type="number" id="pricePS5" value="20000">
          </div>
        </div>
      </div>
      
      <h3 style="color:var(--primary);margin-bottom:15px;">Bar mahsulotlari (Nomi - Narxi - Zaxira)</h3>
      <div class="form-group">
        <label>Har bir mahsulotni yangi qatordan kiriting:</label>
        <textarea id="barItemsInput" placeholder="Pepsi - 8000 - 50&#10;Fanta - 8000 - 30&#10;Choy - 5000 - 100"></textarea>
      </div>
      
      <h3 style="color:var(--danger);margin-bottom:15px;margin-top:30px;">Ma'lumotlar boshqaruvi</h3>
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
          <button class="btn btn-primary" onclick="exportData()">üíæ Ma'lumotlarni Eksport qilish</button>
          <input type="file" id="importFileInput" style="display:none;" onchange="handleImportFile(event)">
          <button class="btn btn-warning" onclick="document.getElementById('importFileInput').click()">üì• Ma'lumotlarni Import qilish</button>
      </div>
      
      <div class="modal-close">
        <button class="btn btn-success" onclick="saveSettings()">Saqlash</button>
        <button class="btn btn-danger" onclick="closeModal('settingsModal')">Yopish</button>
      </div>
    </div>
  </div>
  
  <div class="modal" id="payDebtModal">
    <div class="modal-content">
      <div class="modal-header">üí∞ Qarzni to'lash</div>
      <div class="modal-text" id="payDebtDetails"></div>
      <input type="number" class="modal-input" id="payDebtAmount" placeholder="To'lanadigan summa" />
      <div class="modal-buttons" style="grid-template-columns:1fr 1fr 1fr;">
        <button class="btn btn-success" onclick="confirmPayDebt('cash')" style="background:#3b82f6;">üíµ Naqd</button>
        <button class="btn btn-warning" onclick="confirmPayDebt('transfer')">üí≥ O'tkazma</button>
      </div>
      <div class="modal-close">
        <button class="btn btn-danger" onclick="closeModal('payDebtModal')">Bekor qilish</button>
      </div>
    </div>
  </div>
  
  <div class="modal" id="deleteDebtorModal">
    <div class="modal-content">
      <div class="modal-header">üîí Qarzdorni o'chirish</div>
      <div class="modal-text">Qarzdorni o'chirish uchun sozlamalar parolini kiriting:</div>
      <input type="password" class="modal-input" id="deleteDebtorPassword" placeholder="Parolni kiriting" />
      <div class="modal-close">
        <button class="btn btn-danger" onclick="confirmDeleteDebtor()">O'chirish</button>
        <button class="btn btn-primary" onclick="closeModal('deleteDebtorModal')">Bekor qilish</button>
      </div>
    </div>
  </div>

  <div class="modal" id="exportLogPasswordModal">
    <div class="modal-content">
      <div class="modal-header">üîí Log Eksport</div>
      <div class="modal-text">Log faylini eksport qilish uchun Sozlamalar parolini kiriting:</div>
      <input type="password" class="modal-input" id="exportLogPassword" placeholder="Parolni kiriting" />
      <div class="modal-close">
        <button class="btn btn-success" onclick="confirmLogExport()">Eksport</button>
        <button class="btn btn-danger" onclick="closeModal('exportLogPasswordModal')">Bekor qilish</button>
      </div>
    </div>
  </div>

  <script>
    // ========== ENCRYPTION ==========
    const ENCRYPTION_KEY = 'NOOR_' + Math.random().toString(36).substring(2, 15) + '_SECURE_KEY_' + Date.now();
    
    function encrypt(text) {
      if (!text) return null;
      return CryptoJS.AES.encrypt(text, ENCRYPTION_KEY).toString();
    }
    
    function decrypt(ciphertext) {
      if (!ciphertext) return null;
      try {
        const bytes = CryptoJS.AES.decrypt(ciphertext, ENCRYPTION_KEY);
        const originalText = bytes.toString(CryptoJS.enc.Utf8);
        return originalText || null;
      } catch {
        return null;
      }
    }

    // ========== DATABASE MANAGEMENT ==========
    const DB_NAME = 'noor_gms_database';
    const DB_VERSION = '1.3';
    const API_URL = 'http://localhost:3000/api'; // Supabase backend URL
    const USE_ONLINE_BACKUP = true; // True bo'lsa Supabase'ga saqlash

    function initializeDatabase() {
      if (!localStorage.getItem(DB_NAME)) {
        const initialData = {
          version: DB_VERSION,
          created: new Date().toISOString(),
          lastBackup: null,
          data: {}
        };
        localStorage.setItem(DB_NAME, JSON.stringify(initialData));
      }
    }

    // ========== STATE ==========
    const DEFAULT_STATE = {
      users: [{ username: "noordev", pass: "Noor3112" }], // YANGI STANDART LOGIN
      settingsPassword: "1234",
      transferCardNumber: "1234 1234 1234 1234",
      isLoggedIn: false,
      currentUser: "",
      shiftOpen: false,
      shiftStartTime: null,
      currentShiftId: null,
      cashBalance: 0, 
      transferBalance: 0,
      debtBalance: 0, 
      prices: { b1: 40000, b2: 40000, ps4: 15000, ps5: 20000 },
      barItems: [
        { name: "Pepsi", price: 8000, stock: 50 }, 
        { name: "Fanta", price: 8000, stock: 30 },
        { name: "Choy", price: 5000, stock: 100 }
      ],
      tables: {
        b1: { id: 'b1', name: 'Billiard-1', active: false, running: false, vip: false, items: [], initialSeconds: 0, remainingSeconds: 0, startTime: null, interval: null, alarmed: false, startTimestamp: null }, 
        b2: { id: 'b2', name: 'Billiard-2', active: false, running: false, vip: false, items: [], initialSeconds: 0, remainingSeconds: 0, startTime: null, interval: null, alarmed: false, startTimestamp: null },
        ps4: { id: 'ps4', name: 'PlayStation 4 Pro', active: false, running: false, vip: false, items: [], initialSeconds: 0, remainingSeconds: 0, startTime: null, interval: null, alarmed: false, startTimestamp: null },
        ps5: { id: 'ps5', name: 'PlayStation 5 Slim', active: false, running: false, vip: false, items: [], initialSeconds: 0, remainingSeconds: 0, startTime: null, interval: null, alarmed: false, startTimestamp: null }
      },
      receipts: [],
      history: [],
      debtors: [],
      logs: [],
      notes: "",
      stats: { b1: 0, b2: 0, ps4: 0, ps5: 0, bar: 0 },
      // Volatile state (Saqlanmaydi)
      selectedProduct: null,
      currentTableKey: null,
      currentInputType: null,
      currentDebtData: null,
      currentDebtorToDelete: null,
      currentDebtorToPay: null,
      confirmCallback: null,
      currentPaymentType: 'cash',
      // YANGI: SESSION TIMEOUT
      lastActivity: Date.now(),
      sessionTimeout: 30 * 60 * 1000 // 30 daqiqa
    };
    
    let STATE = JSON.parse(JSON.stringify(DEFAULT_STATE));

    // ========== INITIALIZATION ==========
    function initializePasswords() {
      const savedSettings = localStorage.getItem('noorSettingsPassword');
      const savedCard = localStorage.getItem('noorTransferCard');
      
      STATE.settingsPassword = decrypt(savedSettings) || DEFAULT_STATE.settingsPassword;
      if (!savedSettings) localStorage.setItem('noorSettingsPassword', encrypt(STATE.settingsPassword));

      STATE.transferCardNumber = decrypt(savedCard) || DEFAULT_STATE.transferCardNumber;
      if (!savedCard) localStorage.setItem('noorTransferCard', encrypt(STATE.transferCardNumber));
    }

    // ========== SNOWFALL AND NEW YEAR BANNER ==========
    function checkSeasonalFeatures() {
        const now = new Date();
        const month = now.getMonth(); 
        const day = now.getDate();
        
        if (month === 11 || month === 0) { 
            createSnowfall();
        }
        
        const isNewYearPeriod = (month === 11 && day >= 20) || (month === 0 && day <= 10);
        
        if (isNewYearPeriod) {
            document.getElementById('newYearBanner').className = 'new-year-banner';
            document.getElementById('newYearBanner').innerHTML = `üéâ Yangi yilingiz bilan! | –° –ù–æ–≤—ã–º –≥–æ–¥–æ–º! | Happy New Year! üéä`;
        } else {
            document.getElementById('newYearBanner').innerHTML = '';
            document.getElementById('newYearBanner').className = '';
        }
    }

    function createSnowfall() {
        const container = document.getElementById('snowfallContainer');
        const numFlakes = 50; 
        
        for (let i = 0; i < numFlakes; i++) {
            const flake = document.createElement('div');
            flake.className = 'snowflake';
            flake.innerHTML = '‚ùÑ'; 
            
            const size = Math.random() * 10 + 10; 
            flake.style.fontSize = `${size}px`;
            flake.style.left = `${Math.random() * 100}vw`;
            flake.style.animationDuration = `${Math.random() * 15 + 10}s`; 
            flake.style.animationDelay = `-${Math.random() * 10}s`; 
            
            container.appendChild(flake);
        }
    }

    // ========== CLOCK ==========
    function updateClock() {
      const now = new Date();
      const h = String(now.getHours()).padStart(2, '0');
      const m = String(now.getMinutes()).padStart(2, '0');
      const s = String(now.getSeconds()).padStart(2, '0');
      
      // Asosiy soat
      document.getElementById('mainClock').textContent = `${h}:${m}:${s}`;
      
      // Login ekrandagi soat
      document.getElementById('loginClock').textContent = `${h}:${m}:${s}`;
      
      // Sana va kunni yangilash
      const days = ['Yakshanba', 'Dushanba', 'Seshanba', 'Chorshanba', 'Payshanba', 'Juma', 'Shanba'];
      const dayName = days[now.getDay()];
      const dateStr = now.toLocaleDateString('uz-UZ');
      
      document.getElementById('currentDate').textContent = `${dayName}, ${dateStr}`;
      document.getElementById('loginDate').textContent = `${dayName}, ${dateStr}`;
    }
    
    // ========== SESSION TIMEOUT ==========
    function updateActivity() {
      STATE.lastActivity = Date.now();
    }

    function checkSessionTimeout() {
      const now = Date.now();
      const timeSinceLastActivity = now - STATE.lastActivity;
      
      if (timeSinceLastActivity > STATE.sessionTimeout && STATE.isLoggedIn) {
        // Avtomatik chiqish
        logoutDueToInactivity();
      }
    }

    function logoutDueToInactivity() {
      addLog("Avtomatik chiqish", "Faollik yo'qligi sababli (30 daqiqa)");
      STATE.isLoggedIn = false;
      STATE.currentUser = "";
      document.getElementById('loginScreen').style.opacity = '1';
      document.getElementById('loginScreen').style.visibility = 'visible';
      showNotification('‚ö†Ô∏è 30 daqiqa faollik yo\'qligi sababli tizimdan chiqildi', 5000);
    }

    // Faollikni kuzatish
    document.addEventListener('click', updateActivity);
    document.addEventListener('keypress', updateActivity);
    document.addEventListener('mousemove', updateActivity);

    // ========== LOGIN ==========
    function login() {
      const username = document.getElementById('loginUsername').value.trim();
      const password = document.getElementById('loginPassword').value;

      if (!username || !password) {
        showNotification('‚ö†Ô∏è Login va parolni kiriting!');
        return;
      }

      const user = STATE.users.find(u => u.username === username && u.pass === password);
      
      if (user) {
        STATE.isLoggedIn = true;
        STATE.currentUser = user.username;
        STATE.lastActivity = Date.now(); // Faollikni yangilash
        
        document.getElementById('loginScreen').style.opacity = '0';
        document.getElementById('loginScreen').style.visibility = 'hidden';
        document.getElementById('logoutBtn').style.display = 'block'; // Logout tugmasini ko'rsatish
        
        addLog("Tizimga kirish", `Foydalanuvchi: ${user.username}`);
        loadData(); 
        renderPage('billiard');
      } else {
        showNotification('‚ùå Noto\'g\'ri login yoki parol!');
        addLog("Kirishda xatolik", `Login: ${username}`);
      }
    }

    // ========== LOGOUT ==========
    function logout() {
      showConfirm('Tizimdan chiqishni tasdiqlaysizmi?', () => {
        if (STATE.shiftOpen) {
          showConfirm('‚ö†Ô∏è Smena hali ochiq! Uni yopib chiqishni tasdiqlaysizmi?', () => {
            const shiftData = {
              shiftId: STATE.currentShiftId,
              employeeName: STATE.currentUser,
              startTime: STATE.shiftStartTime,
              endTime: new Date().toLocaleString('uz-UZ'),
              cashBalance: STATE.cashBalance,
              transferBalance: STATE.transferBalance,
              debtBalance: STATE.debtBalance,
              stats: { ...STATE.stats },
              receipts: [...STATE.receipts],
              timestamp: Date.now()
            };
            STATE.history.push(shiftData);
            
            STATE.shiftOpen = false;
            STATE.cashBalance = 0;
            STATE.transferBalance = 0;
            STATE.stats = { b1: 0, b2: 0, ps4: 0, ps5: 0, bar: 0 };
            STATE.receipts = [];
            
            Object.keys(STATE.tables).forEach(key => {
              if (STATE.tables[key].active) {
                clearSessionState(key);
              }
            });
            
            performLogout();
          });
        } else {
          performLogout();
        }
      });
    }

    function performLogout() {
      STATE.isLoggedIn = false;
      STATE.currentUser = "";
      
      addLog("Tizimdan chiqish", "");
      saveData();
      
      document.getElementById('logoutBtn').style.display = 'none';
      document.getElementById('loginScreen').style.opacity = '1';
      document.getElementById('loginScreen').style.visibility = 'visible';
      
      document.getElementById('loginUsername').value = '';
      document.getElementById('loginPassword').value = '';
      
      updateUI();
      showNotification('‚úÖ Tizimdan chiqtingiz!', 2000);
    }

    // ========== LOGGING ==========
    function addLog(action, details = "") {
        STATE.logs.push({
            timestamp: new Date().toLocaleString('uz-UZ'),
            user: STATE.currentUser,
            action: action,
            details: details
        });
        // Loglarni 30 kundan keyin tozalash
        cleanOldLogs();
    }

    // ========== DATA MANAGEMENT ==========
    function loadData() {
      // Avval yangi ma'lumotlar bazasidan urinib ko'rish
      const db = localStorage.getItem(DB_NAME);
      if (db) {
        try {
          const database = JSON.parse(db);
          if (database.data) {
            const data = database.data;
            
            const persistentKeys = Object.keys(DEFAULT_STATE).filter(k => ![
                'settingsPassword', 'transferCardNumber', 
                'isLoggedIn', 'tables', 'currentUser', 'lastActivity', 'sessionTimeout'
            ].includes(k));
            
            persistentKeys.forEach(key => {
              if (data[key] !== undefined) STATE[key] = data[key];
            });
            
            // Qarz balansini yangilash
            STATE.debtBalance = STATE.debtors.reduce((sum, d) => sum + d.totalDebt, 0);

            if (data.tables) {
               Object.keys(DEFAULT_STATE.tables).forEach(key => {
                  if (data.tables[key]) {
                      Object.assign(STATE.tables[key], data.tables[key]);
                      
                      STATE.tables[key].interval = null; 
                      if (STATE.tables[key].active) {
                          startTimer(key);
                      }
                  }
               });
            }

          }
        } catch (e) {
          console.error('Database load error:', e);
          // Eski usul bilan yuklash
          loadLegacyData();
        }
      } else {
        // Eski usul bilan yuklash
        loadLegacyData();
      }
      
      cleanOldHistory();
      cleanOldReceipts();
      cleanOldLogs();
      updateUI();
    }

    function loadLegacyData() {
      const saved = localStorage.getItem('noorData');
      if (saved) {
        try {
          const data = JSON.parse(saved);
          
          const persistentKeys = Object.keys(DEFAULT_STATE).filter(k => ![
              'settingsPassword', 'transferCardNumber', 
              'isLoggedIn', 'tables', 'currentUser', 'lastActivity', 'sessionTimeout'
          ].includes(k));
          
          persistentKeys.forEach(key => {
            if (data[key] !== undefined) STATE[key] = data[key];
          });
          
          // Qarz balansini yangilash
          STATE.debtBalance = STATE.debtors.reduce((sum, d) => sum + d.totalDebt, 0);

          if (data.tables) {
             Object.keys(DEFAULT_STATE.tables).forEach(key => {
                if (data.tables[key]) {
                    Object.assign(STATE.tables[key], data.tables[key]);
                    
                    STATE.tables[key].interval = null; 
                    if (STATE.tables[key].active) {
                        startTimer(key);
                    }
                }
             });
          }

        } catch (e) {
          console.error('Legacy data load error:', e);
          showNotification('‚ö†Ô∏è Ma\'lumot yuklashda xatolik yuz berdi. Dastur toza holatda ishga tushirildi.');
          STATE = JSON.parse(JSON.stringify(DEFAULT_STATE)); 
        }
      }
    }

    function saveData() {
      try {
        // Yangi ma'lumotlar bazasiga saqlash (asosiy)
        const db = JSON.parse(localStorage.getItem(DB_NAME) || '{}');
        
        const toSave = {};
        const persistentKeys = Object.keys(DEFAULT_STATE).filter(k => ![
          'settingsPassword', 'transferCardNumber', 'isLoggedIn', 
          'currentTableKey', 'currentInputType', 'currentDebtData', 'currentDebtorToDelete', 
          'currentDebtorToPay', 'confirmCallback', 'selectedProduct', 'currentPaymentType', 'currentUser',
          'lastActivity', 'sessionTimeout'
        ].includes(k));
        
        persistentKeys.forEach(key => {
          toSave[key] = STATE[key];
        });

        toSave.tables = JSON.parse(JSON.stringify(STATE.tables));
        Object.keys(toSave.tables).forEach(key => {
            toSave.tables[key].interval = null;
        });
        
        db.data = toSave;
        db.lastModified = new Date().toISOString();
        localStorage.setItem(DB_NAME, JSON.stringify(db));
        
        // Eski usul bilan ham saqlash (qayta ishlash uchun)
        localStorage.setItem('noorData', JSON.stringify(toSave));
        
        // YANGI: Backup saqlash (4 soatdan keyin o'chiriladi)
        const backupKey = 'noorData_backup_' + Math.floor(Date.now() / (4 * 60 * 60 * 1000)) * (4 * 60 * 60 * 1000);
        localStorage.setItem(backupKey, JSON.stringify(toSave));
        
        // YANGI: Supabase'ga saqlash (opsional)
        if (USE_ONLINE_BACKUP && STATE.currentUser) {
          saveToSupabase(toSave);
        }
        
      } catch (e) {
        console.error('Save error:', e);
      }
    }

    // YANGI: Supabase'ga saqlash
    async function saveToSupabase(data) {
      try {
        const response = await fetch(`${API_URL}/save-data`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            userId: STATE.currentUser,
            data: data,
            timestamp: new Date().toISOString()
          })
        });

        if (!response.ok) {
          console.error('Supabase save failed:', await response.text());
          return;
        }

        const result = await response.json();
        console.log('Supabase saqlandi:', result);
      } catch (e) {
        console.error('Supabase save error:', e);
      }
    }

    // YANGI: Supabase'dan yuklash
    async function loadFromSupabase(username) {
      try {
        const response = await fetch(`${API_URL}/load-data/${username}`);
        
        if (!response.ok) {
          console.error('Supabase load failed');
          return null;
        }

        const result = await response.json();
        return result.data || null;
      } catch (e) {
        console.error('Supabase load error:', e);
        return null;
      }
    }

    function cleanOldHistory() {
      const now = Date.now();
      const sevenDays = 7 * 24 * 60 * 60 * 1000;
      STATE.history = STATE.history.filter(h => (now - h.timestamp) < sevenDays);
    }
    
    function cleanOldReceipts() {
      const now = Date.now();
      const sevenDays = 7 * 24 * 60 * 60 * 1000;
      STATE.receipts = STATE.receipts.filter(r => (now - r.timestamp) < sevenDays);
    }
    
    function cleanOldLogs() {
      const now = Date.now();
      const thirtyDays = 30 * 24 * 60 * 60 * 1000;
      STATE.logs = STATE.logs.filter(l => (now - new Date(l.timestamp).getTime()) < thirtyDays);
    }
    
    // ========== DATA EXPORT/IMPORT ==========
    function exportData() {
        saveData(); 
        const data = localStorage.getItem('noorData');
        const passwords = {
            settingsPassword: encrypt(STATE.settingsPassword),
            transferCardNumber: encrypt(STATE.transferCardNumber)
        };
        
        const exportObj = {
            version: '1.3', 
            timestamp: Date.now(),
            data: data,
            passwords: passwords
        };
        
        const json = JSON.stringify(exportObj, null, 2);
        const blob = new Blob([json], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `noor_data_export_${new Date().toISOString().slice(0, 10)}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showNotification('‚úÖ Ma\'lumotlar muvaffaqiyatli eksport qilindi!');
    }

    function handleImportFile(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const importObj = JSON.parse(e.target.result);
                
                if (importObj.data && importObj.passwords) {
                    showConfirm("‚ö†Ô∏è Ma'lumotlarni import qilish mavjud ma'lumotlaringizni o'chiradi. Davom etishni tasdiqlaysizmi?", () => {
                        localStorage.setItem('noorData', importObj.data);
                        localStorage.setItem('noorSettingsPassword', importObj.passwords.settingsPassword);
                        localStorage.setItem('noorTransferCard', importObj.passwords.transferCardNumber);
                        
                        Object.keys(STATE.tables).forEach(key => {
                            if (STATE.tables[key].interval) {
                                clearInterval(STATE.tables[key].interval);
                            }
                        });

                        initializePasswords();
                        loadData(); 
                        closeModal('settingsModal');
                        renderPage(getCurrentPage());
                        showNotification('‚úÖ Ma\'lumotlar muvaffaqiyatli import qilindi!');
                    });
                } else {
                    showNotification('‚ùå Import fayli formati noto\'g\'ri!');
                }
            } catch (error) {
                showNotification('‚ùå Import faylini o\'qishda xatolik: ' + error.message);
            }
            event.target.value = '';
        };
        reader.readAsText(file);
    }

    // ========== MODAL HELPERS ==========
    function openModal(id) {
      document.getElementById(id).classList.add('show');
    }

    function closeModal(id) {
      document.getElementById(id).classList.remove('show');
      if (id === 'alarmModal') {
          const key = STATE.currentTableKey;
          if (key && STATE.tables[key].alarmed) {
              STATE.tables[key].alarmed = false;
          }
      }
    }
    
    function closePaymentModal(isCancelled = false) {
        if (isCancelled && STATE.currentDebtData) {
            const details = STATE.currentDebtData.table ? STATE.currentDebtData.table : (STATE.currentDebtData.barItem ? STATE.currentDebtData.barItem.name : "Noma'lum");
            addLog("To'lov bekor qilindi", details);
            addReceipt({
                type: 'cancelled',
                total: 0,
                details: details,
                time: new Date().toLocaleString('uz-UZ'),
            });
        }
        
        closeModal('paymentModal');
        document.getElementById('paymentModalHeader').textContent = "üí≥ To'lov";
        document.getElementById('paymentModalDebtBtn').style.display = 'block';
        
        // Vaqtinchalik holatni tozalash
        STATE.currentTableKey = null;
        STATE.currentDebtData = null;
        STATE.currentPaymentType = 'cash';
    }
    
    function showNotification(text, duration = 2000) {
      document.getElementById('notificationText').innerHTML = text;
      openModal('notificationModal');
      
      setTimeout(() => {
        closeModal('notificationModal');
      }, duration);
    }
    
    function showConfirm(text, callback) {
      document.getElementById('confirmText').innerHTML = text;
      STATE.confirmCallback = callback;
      openModal('confirmModal');
    }
    
    function confirmAction() {
      closeModal('confirmModal');
      if (STATE.confirmCallback) {
        STATE.confirmCallback();
        STATE.confirmCallback = null;
      }
    }

    // ========== SHIFT MANAGEMENT ==========
    function toggleShift() {
      if (!STATE.shiftOpen) {
        if (!STATE.currentUser) {
            showNotification('‚ö†Ô∏è Iltimos, avval tizimga kiring!');
            return;
        }
        STATE.shiftOpen = true;
        STATE.shiftStartTime = new Date().toLocaleString('uz-UZ');
        STATE.currentShiftId = Date.now();
        STATE.cashBalance = 0; 
        STATE.transferBalance = 0;
        STATE.stats = { b1: 0, b2: 0, ps4: 0, ps5: 0, bar: 0 };
        STATE.receipts = [];
        
        addLog("Smena ochildi", `Xodim: ${STATE.currentUser}`);
        showNotification(`‚úÖ Smena muvaffaqiyatli ochildi! (Xodim: ${STATE.currentUser})`);
      } else {
        showConfirm('Smenani yopishni tasdiqlaysizmi? Faol sessiyalar avtomatik to\'xtatiladi.', () => {
          const shiftData = {
            shiftId: STATE.currentShiftId,
            employeeName: STATE.currentUser, 
            startTime: STATE.shiftStartTime,
            endTime: new Date().toLocaleString('uz-UZ'),
            cashBalance: STATE.cashBalance,
            transferBalance: STATE.transferBalance,
            debtBalance: STATE.debtBalance,
            stats: { ...STATE.stats },
            receipts: [...STATE.receipts],
            timestamp: Date.now()
          };
          STATE.history.push(shiftData);
          
          STATE.shiftOpen = false;
          STATE.shiftStartTime = null;
          STATE.currentShiftId = null;
          STATE.cashBalance = 0;
          STATE.transferBalance = 0;
          STATE.stats = { b1: 0, b2: 0, ps4: 0, ps5: 0, bar: 0 };
          STATE.receipts = [];
          
          Object.keys(STATE.tables).forEach(key => {
            if (STATE.tables[key].active) {
              stopSession(key, true); 
            }
          });
          
          addLog("Smena yopildi", `Jami tushum: ${shiftData.cashBalance + shiftData.transferBalance} so'm`);
          showNotification('‚úÖ Smena yopildi!');
          updateUI();
          renderPage(getCurrentPage()); 
          saveData();
        });
      }
      updateUI();
      saveData();
    }

    // ========== NAVIGATION ==========
    document.querySelectorAll('.nav button').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        if (btn.dataset.page === 'settings') {
          openSettingsPasswordModal();
        } else {
          renderPage(btn.dataset.page);
        }
      });
    });
    
    function getCurrentPage() {
      const active = document.querySelector('.nav button.active');
      return active ? active.dataset.page : 'billiard';
    }

    // ========== PAGES ==========
    function renderPage(page) {
        const content = document.getElementById('contentArea');
        content.innerHTML = ''; 

        if (page === 'billiard') {
          content.innerHTML = `
            <h2 style="color:var(--primary);margin-bottom:20px;">üé± Billiard</h2>
            <div class="game-grid">
              ${renderGameCard('b1')}
              ${renderGameCard('b2')}
            </div>
          `;
        } else if (page === 'playstation') {
          content.innerHTML = `
            <h2 style="color:var(--primary);margin-bottom:20px;">üéÆ PlayStation</h2>
            <div class="game-grid">
              ${renderGameCard('ps4')}
              ${renderGameCard('ps5')}
            </div>
          `;
        } else if (page === 'bar') {
          renderBarPage(); 
        } else if (page === 'debtors') {
          renderDebtorsPage(); 
        } else if (page === 'history') {
          renderHistoryPage(); 
        } else if (page === 'log') {
          renderLogPage();
        }
        updateTimersUI(); 
      }
      
    function renderGameCard(key) {
        const table = STATE.tables[key];
        const isActive = table.active;
        const barTotal = table.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        
        return `
          <div class="game-card ${table.vip ? 'vip' : ''} ${table.active && table.remainingSeconds < 30 && table.remainingSeconds > 0 ? 'time-low' : ''}" id="card-${key}">
            ${table.vip ? '<span class="vip-badge">‚≠ê VIP (+50% Narx)</span>' : ''}
            <div class="card-header">
              <div class="card-title">${table.name}</div>
              <span class="status-badge ${isActive ? 'status-active' : 'status-free'}">
                ${isActive ? (table.running ? 'üü¢ Faol' : '‚è∏Ô∏è Pauzada') : '‚ö™ Bo\'sh'}
              </span>
            </div>
            
            ${isActive ? `
              <div class="timer-display" id="timer-${key}">${formatTime(table.remainingSeconds)}</div>
              <div class="cost-display" id="cost-${key}">${calculateCost(key)} so'm</div>
              <div class="game-buttons">
                <button class="btn btn-primary" onclick="addTime('${key}')">‚ûï Vaqt/Pul</button>
                <button class="btn btn-success" onclick="toggleTimer('${key}')" id="toggleBtn-${key}">${table.running ? '‚è∏Ô∏è Pauza' : '‚ñ∂Ô∏è Davom'}</button>
                <button class="btn btn-danger" onclick="stopSession('${key}', false)">‚èπÔ∏è To'xtatish</button>
                ${!table.vip ? `<button class="btn btn-warning" onclick="setVip('${key}')">‚≠ê VIP</button>` : `<button class="btn btn-warning" onclick="removeVip('${key}')">‚úñÔ∏è VIP</button>`}
              </div>
            ` : `
              <div style="text-align:center;margin:30px 0;">
                <button class="btn btn-primary" style="padding:15px 30px;font-size:1.1rem;" onclick="startSession('${key}')">‚ñ∂Ô∏è Boshlash</button>
              </div>
            `}
            
            <div class="bar-items-list">
              <strong style="color:var(--primary);">üçπ Bar mahsulotlari:</strong>
              ${table.items.length > 0 ? table.items.map((item, idx) => `
                <div class="bar-item-row">
                  <span>${item.name} x${item.quantity}</span>
                  <span>${item.price * item.quantity} so'm</span>
                  <button class="remove-item" onclick="removeBarItem('${key}', ${idx})">‚ùå</button>
                </div>
              `).join('') : '<div style="text-align:center;color:var(--text-dim);margin:10px 0;">Bo\'sh</div>'}
              ${barTotal > 0 ? `<div class="bar-total">Bar jami: ${barTotal} so'm</div>` : ''}
            </div>
          </div>
        `;
      }
      
    // ========== GAME SESSIONS ==========
    
    function addTime(key) {
      STATE.currentTableKey = key;
      document.getElementById('startModalTable').textContent = `Stol: ${STATE.tables[key].name}`;
      openModal('startModal');
    }
    
    function startSession(key) {
      if (!STATE.shiftOpen) {
        showNotification('‚ö†Ô∏è Avval smenani oching!');
        return;
      }
      addTime(key);
    }
    
    function selectInputType(type) {
      closeModal('startModal');
      STATE.currentInputType = type;
      
      const key = STATE.currentTableKey;
      const isNewSession = !STATE.tables[key].active;

      if (type === 'time') {
        document.getElementById('inputModalTitle').textContent = `‚è∞ ${isNewSession ? 'Boshlang\'ich' : 'Qo\'shimcha'} Vaqt kiriting (daqiqa)`;
        document.getElementById('inputModalValue').placeholder = 'Masalan: 60';
      } else {
        document.getElementById('inputModalTitle').textContent = `üí∞ ${isNewSession ? 'Boshlang\'ich' : 'Qo\'shimcha'} Pul kiriting (so\'m)`;
        document.getElementById('inputModalValue').placeholder = 'Masalan: 20000';
      }
      
      document.getElementById('inputModalValue').value = '';
      openModal('inputModal');
      setTimeout(() => document.getElementById('inputModalValue').focus(), 300);
    }
    
    function confirmInput() {
      const value = document.getElementById('inputModalValue').value;
      if (!value || parseFloat(value) <= 0) {
        showNotification('‚ö†Ô∏è To\'g\'ri qiymat kiriting!');
        return;
      }
      
      const key = STATE.currentTableKey;
      const isNewSession = !STATE.tables[key].active;
      
      let secondsToAdd = 0;
      
      if (STATE.currentInputType === 'time') {
        secondsToAdd = parseInt(value) * 60;
      } else {
        const pricePerHour = STATE.prices[key] * (STATE.tables[key].vip ? 1.5 : 1);
        const pricePerMinute = pricePerHour / 60; 
        const seconds = Math.round((parseInt(value) / pricePerMinute) * 60);
        secondsToAdd = seconds;
      }
      
      if (secondsToAdd <= 0) {
          showNotification('‚ö†Ô∏è Kiritilgan pul yoki vaqt hisobga olinmadi (Narx juda kam).');
          return;
      }

      if (isNewSession) {
        STATE.tables[key].active = true;
        STATE.tables[key].running = true;
        STATE.tables[key].remainingSeconds = secondsToAdd;
        STATE.tables[key].initialSeconds = secondsToAdd;
        STATE.tables[key].startTime = new Date().toLocaleString('uz-UZ');
        STATE.tables[key].startTimestamp = Date.now();
        STATE.tables[key].alarmed = false; 
        
        startTimer(key);
        addLog("Sessiya boshlandi", `${STATE.tables[key].name} (${formatTime(secondsToAdd)})`);
      } else {
        const currentElapsedSeconds = STATE.tables[key].initialSeconds - STATE.tables[key].remainingSeconds;
        STATE.tables[key].remainingSeconds += secondsToAdd;
        STATE.tables[key].initialSeconds = currentElapsedSeconds + STATE.tables[key].remainingSeconds;
        
        if (!STATE.tables[key].running) {
            STATE.tables[key].running = true;
        }
        addLog("Vaqt qo'shildi", `${STATE.tables[key].name} (${formatTime(secondsToAdd)})`);
      }
      
      closeModal('inputModal');
      renderPage(getCurrentPage());
      updateUI();
      saveData();
      
      showNotification(`‚úÖ ${STATE.tables[key].name} ga ${isNewSession ? 'boshlang\'ich vaqt' : 'qo\'shimcha vaqt'} qo'shildi!`);
    }

    function startTimer(key) {
        const table = STATE.tables[key];
        if (!table || table.interval) return;

        table.interval = setInterval(() => {
            if (!table.running) return;
            
            table.remainingSeconds--;
            
            if (table.remainingSeconds === 30 && !table.alarmed) {
                table.alarmed = true; 
                STATE.currentTableKey = key; 
                document.getElementById('alarmText').textContent = `${table.name} uchun vaqt tugashiga 30 soniya qoldi!`;
                openModal('alarmModal');
            }

            const currentPage = getCurrentPage();
            const tableType = key.includes('b') ? 'billiard' : 'playstation';
            
            if (currentPage === 'billiard' || currentPage === 'playstation') {
                updateTimerUI(key);
            }
            
            updateActiveSessions();
            
            if (table.remainingSeconds <= 0) {
                clearInterval(table.interval);
                table.interval = null;
                table.running = false; 
                table.remainingSeconds = 0; 
                updateTimerUI(key); 
                showNotification(`‚è∞ ${table.name} vaqti tugadi! To'lovga o'tkaziladi.`, 2000); 
                stopSession(key, false); 
            }
            
        }, 1000); 
        
        updateActiveSessions();
    }
    
    function calculateCost(key) {
        const table = STATE.tables[key];
        const elapsed = table.initialSeconds - table.remainingSeconds;
        const pricePerHour = STATE.prices[key] * (table.vip ? 1.5 : 1);
        
        const secondsForCost = Math.max(0, elapsed); 
        const cost = Math.max(0, Math.round((secondsForCost / 3600) * pricePerHour));
        
        return cost;
    }

    function updateTimerUI(key) {
        const table = STATE.tables[key];
        if (!table) return;

        const timerEl = document.getElementById(`timer-${key}`);
        const costEl = document.getElementById(`cost-${key}`);
        const cardEl = document.getElementById(`card-${key}`);

        if (timerEl) timerEl.textContent = formatTime(table.remainingSeconds);
        if (cardEl) {
            if (table.active && table.remainingSeconds < 30 && table.remainingSeconds > 0) {
                cardEl.classList.add('time-low');
            } else {
                cardEl.classList.remove('time-low');
            }
        }
        
        const cost = calculateCost(key); 

        if (costEl) costEl.textContent = `${cost} so'm`;
    }
    
    function updateTimersUI() {
        Object.keys(STATE.tables).forEach(key => {
            if (STATE.tables[key].active) {
                updateTimerUI(key);
            }
        });
    }

    function toggleTimer(key) {
      const table = STATE.tables[key];
      if (!table || !table.active) return;
      
      table.running = !table.running;
      const btn = document.getElementById(`toggleBtn-${key}`);
      if (btn) btn.innerHTML = table.running ? '‚è∏Ô∏è Pauza' : '‚ñ∂Ô∏è Davom';

      const statusBadge = document.querySelector(`#card-${key} .status-badge`);
      if (statusBadge) statusBadge.innerHTML = table.running ? 'üü¢ Faol' : '‚è∏Ô∏è Pauzada';
      
      addLog(table.running ? "Sessiya davom etdi" : "Sessiya pauza qilindi", table.name);
      saveData();
      showNotification(`‚úÖ ${table.name} ${table.running ? 'davom ettirildi' : 'pauza qilindi'}!`, 1000);
    }

    function stopSession(key, silent = false) {
      const table = STATE.tables[key];
      if (!table || !table.active) return;
      
      if (table.interval) clearInterval(table.interval);
      table.interval = null;
      table.running = false; 

      const elapsedSeconds = table.initialSeconds - table.remainingSeconds;
      const gameCost = calculateCost(key); 
      
      const barTotal = table.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      const totalCost = gameCost + barTotal;
      
      if (!silent) {
        STATE.currentTableKey = key;
        STATE.currentDebtData = {
          table: table.name,
          startTime: table.startTime,
          duration: formatTime(elapsedSeconds),
          gameCost: gameCost,
          barItems: [...table.items],
          barTotal: barTotal,
          total: totalCost,
          vip: table.vip
        };
        
        document.getElementById('paymentModalHeader').textContent = `üí≥ To'lov (${table.name})`;
        document.getElementById('paymentDetails').innerHTML = `
          <div style="background:var(--bg);padding:15px;border-radius:8px;margin-bottom:15px;">
            <div style="display:flex;justify-content:space-between;margin:5px 0;">
              <span>O'yin (${formatTime(elapsedSeconds)}):</span>
              <span><strong>${gameCost} so'm</strong></span>
            </div>
            ${barTotal > 0 ? `
              <div style="display:flex;justify-content:space-between;margin:5px 0;">
                <span>Bar:</span>
                <span><strong>${barTotal} so'm</strong></span>
              </div>
            ` : ''}
            <div style="display:flex;justify-content:space-between;margin-top:10px;padding-top:10px;border-top:2px solid var(--primary);">
              <span style="font-size:1.1rem;"><strong>JAMI:</strong></span>
              <span style="font-size:1.2rem;color:var(--success);"><strong>${totalCost} so'm</strong></span>
            </div>
          </div>
        `;
        
        document.getElementById('paymentModalDebtBtn').style.display = 'block';
        selectPaymentType('cash', document.getElementById('payBtnCash'));
        openModal('paymentModal');
      } else {
        clearSessionState(key);
        updateUI();
        saveData();
      }
    }

    function clearSessionState(key) {
        if (STATE.tables[key].interval) clearInterval(STATE.tables[key].interval);
        STATE.tables[key].interval = null;
        STATE.tables[key].active = false;
        STATE.tables[key].running = false;
        STATE.tables[key].vip = false;
        STATE.tables[key].items = [];
        STATE.tables[key].remainingSeconds = 0;
        STATE.tables[key].initialSeconds = 0;
        STATE.tables[key].alarmed = false;
    }
    
    // ========== PAYMENT LOGIC ==========
    function selectPaymentType(type, btn) {
        STATE.currentPaymentType = type;
        document.querySelectorAll('#paymentModal .modal-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }

    function confirmPayment() {
      const type = STATE.currentPaymentType;
      
      if (type === 'transfer') {
          document.getElementById('transferCardNumber').textContent = STATE.transferCardNumber;
          document.getElementById('transferAmountDisplay').textContent = STATE.currentDebtData.total;
          openModal('transferModal');
      } else {
          finalizePayment('cash');
      }
    }
    
    function finalizePayment(type) {
        const key = STATE.currentTableKey;
        const data = STATE.currentDebtData;
        
        if (!data) {
            showNotification('‚ùå To\'lov ma\'lumotlarida xatolik!', 3000);
            return;
        }

        const totalAmount = data.total;
        
        if (type === 'transfer') {
            STATE.transferBalance += totalAmount;
            closeModal('transferModal');
        } else {
            STATE.cashBalance += totalAmount;
        }

        // Statistika va Chek yaratish
        if (key) { 
            if (data.gameCost > 0) {
                STATE.stats[key] += data.gameCost;
            }
            if (data.barTotal > 0) {
                STATE.stats.bar += data.barTotal;
            }
            
            addReceipt({
                type: 'game',
                table: data.table,
                startTime: data.startTime,
                endTime: new Date().toLocaleString('uz-UZ'),
                duration: data.duration,
                gameCost: data.gameCost,
                barItems: data.barItems,
                barTotal: data.barTotal,
                total: data.total,
                paid: totalAmount,
                paymentType: type, 
                vip: data.vip
            });
            
            addLog("To'lov (Sessiya)", `${data.table}: ${totalAmount} so'm (${type})`);
            clearSessionState(key);
            
        } else if (data.barItem) { 
            STATE.stats.bar += totalAmount;
            const product = STATE.barItems.find(i => i.name === data.barItem.name);
            if (product) {
                product.stock -= data.qty; 
            }
            
            addReceipt({
                type: 'bar-customer',
                item: data.barItem.name,
                quantity: data.qty,
                price: data.barItem.price,
                total: totalAmount,
                time: new Date().toLocaleString('uz-UZ'),
                paymentType: type
            });
            
            addLog("To'lov (Bar)", `${data.barItem.name} x${data.qty}: ${totalAmount} so'm (${type})`);
            updateBarGrid(); 
        }
        
        closePaymentModal();
        renderPage(getCurrentPage());
        updateUI();
        saveData();
        
        showNotification(`‚úÖ To'lov qabul qilindi! (${type.toUpperCase()})`);
    }

    // ========== DEBT MANAGEMENT ==========
    function addToDebt() {
        closeModal('paymentModal'); 
        
        const list = document.getElementById('existingDebtorsList');
        list.innerHTML = ''; 
        const debtors = STATE.debtors.filter(d => d.totalDebt > 0);
        
        if (debtors.length > 0) {
            debtors.forEach(debtor => {
                const safeName = debtor.name.replace(/'/g, "\\'");
                list.innerHTML += `<button class="modal-btn" onclick="confirmDebtName('${safeName}')">${debtor.name} (${debtor.totalDebt} so'm)</button>`;
            });
        } else {
            list.innerHTML = `<div style="color:var(--text-dim); text-align:center;">Mavjud qarzdorlar yo'q.</div>`;
        }
        
        openModal('selectDebtorModal');
    }

    function openNewDebtorModal() {
        closeModal('selectDebtorModal');
        document.getElementById('newDebtorName').value = '';
        openModal('newDebtorModal');
        setTimeout(() => document.getElementById('newDebtorName').focus(), 300);
    }
    
    function confirmDebtName(name) { 
        let debtorName = name;
        
        if (!debtorName) { 
            debtorName = document.getElementById('newDebtorName').value.trim();
            if (!debtorName) {
                showNotification('‚ö†Ô∏è Ism kiriting!');
                return;
            }
        }
        
        const key = STATE.currentTableKey; 
        const data = STATE.currentDebtData; 

        if (!data) { 
            showNotification('‚ùå Sessiya ma\'lumotlarida xato!', 3000);
            closeModal('newDebtorModal');
            closeModal('selectDebtorModal');
            return;
        }

        STATE.debtBalance += data.total; 

        let debtor = STATE.debtors.find(d => d.name.toLowerCase() === debtorName.toLowerCase());
        
        if (!debtor) {
            debtor = { name: debtorName, totalDebt: 0, debts: [] };
            STATE.debtors.push(debtor);
        }
        
        debtor.debts.push({
            ...data,
            endTime: new Date().toLocaleString('uz-UZ'),
            timestamp: Date.now()
        });
        
        debtor.totalDebt += data.total; 
        
        addReceipt({
            type: 'debt-added',
            name: debtorName,
            table: data.table,
            total: data.total,
            time: new Date().toLocaleString('uz-UZ'),
        });
        
        addLog("Qarzga yozildi", `${data.table}: ${data.total} so'm -> ${debtorName}`);
        
        clearSessionState(key);
        
        closeModal('newDebtorModal');
        closeModal('selectDebtorModal');
        
        STATE.currentTableKey = null;
        STATE.currentDebtData = null;

        renderPage(getCurrentPage()); 
        updateUI(); 
        saveData();
        
        showNotification(`‚úÖ Qarz saqlandi: ${debtorName} - ${data.total} so'm`);
    }

    function setVip(key) {
      if (!STATE.tables[key] || STATE.tables[key].vip) return;
      STATE.tables[key].vip = true;
      addLog("VIP yoqildi", STATE.tables[key].name);
      showNotification('‚≠ê VIP rejim yoqildi! Narx 1.5x oshdi.');
      if(STATE.tables[key].running) startTimer(key);
      renderPage(getCurrentPage());
      saveData();
    }
    
    function removeVip(key) {
      if (!STATE.tables[key] || !STATE.tables[key].vip) return;
      STATE.tables[key].vip = false;
      addLog("VIP o'chirildi", STATE.tables[key].name);
      showNotification('‚≠ê VIP rejim o\'chirildi! Narx qayta tiklandi.');
      if(STATE.tables[key].running) startTimer(key);
      renderPage(getCurrentPage());
      saveData();
    }

    // ========== BAR & INVENTORY ==========
    function renderBarPage() {
        const content = document.getElementById('contentArea');
        content.innerHTML = `
            <h2 style="color:var(--primary);margin-bottom:20px;">üçπ Bar Mahsulotlari</h2>
            <div class="bar-products-grid" id="barGrid"></div>
        `;
        updateBarGrid();
    }

    function updateBarGrid() {
      const grid = document.getElementById('barGrid');
      if (!grid) return;
      
      grid.innerHTML = STATE.barItems.map((item, idx) => `
        <div class="bar-product-card" onclick="selectBarProduct(${idx})" style="${item.stock <= 0 ? 'background:var(--danger);opacity:0.6;cursor:not-allowed;' : ''}">
          <div class="product-name">${item.name}</div>
          <div class="product-price">${item.price} so'm</div>
          <div style="font-size:0.8rem;margin-top:5px;color:${item.stock <= 5 ? 'var(--warning)' : '#fff'};">Zaxira: ${item.stock}</div>
        </div>
      `).join('');
    }

    function selectBarProduct(idx) {
      if (!STATE.shiftOpen) {
        showNotification('‚ö†Ô∏è Avval smenani oching!');
        return;
      }
      
      STATE.selectedProduct = STATE.barItems[idx];

      if (STATE.selectedProduct.stock <= 0) {
        showNotification(`‚ùå ${STATE.selectedProduct.name} zaxirada qolmadi!`, 3000);
        return;
      }
      
      const buttonsDiv = document.getElementById('barTargetButtons');
      
      const activeTables = Object.keys(STATE.tables).filter(key => STATE.tables[key].active);

      buttonsDiv.innerHTML = activeTables.map(key => {
        const table = STATE.tables[key];
        return `
          <button class="modal-btn" onclick="addBarItemToTable('${key}')">
            ${table.name}
          </button>
        `;
      }).join('');
      
      openModal('barProductModal');
    }

    function addBarItemToTable(tableKey) {
      const product = STATE.selectedProduct;
      if (!product) return;
      
      closeModal('barProductModal');
      
      document.getElementById('inputModalTitle').textContent = `üì¶ ${product.name} miqdori (Max: ${product.stock})`;
      document.getElementById('inputModalValue').placeholder = 'Masalan: 2';
      document.getElementById('inputModalValue').value = '1';
      
      STATE.currentTableKey = tableKey;
      STATE.currentInputType = 'bar-quantity-table'; 
      
      openModal('inputModal');
      
      const oldConfirm = window.confirmInput;
      window.confirmInput = function() {
        if (STATE.currentInputType !== 'bar-quantity-table') {
            oldConfirm(); 
            return;
        }

        const qty = parseInt(document.getElementById('inputModalValue').value);
        if (isNaN(qty) || qty <= 0 || qty > product.stock) {
          showNotification(`‚ö†Ô∏è To'g'ri miqdor kiriting! (Max: ${product.stock})`);
          return;
        }
        
        const existing = STATE.tables[tableKey].items.find(i => i.name === product.name);
        
        if (existing) {
          existing.quantity += qty;
        } else {
          STATE.tables[tableKey].items.push({
            name: product.name,
            price: product.price,
            quantity: qty
          });
        }
        
        product.stock -= qty; 
        
        addLog("Bar (Stolga)", `${STATE.tables[tableKey].name} - ${product.name} x${qty}`);
        closeModal('inputModal');
        window.confirmInput = oldConfirm;
        
        renderPage(getCurrentPage());
        saveData();
        showNotification(`‚úÖ Qo'shildi: ${product.name} x${qty}`);
        updateActiveSessions();
        updateBarGrid();
      };
    }

    function sellToCustomer() {
      const product = STATE.selectedProduct;
      if (!product) return;
      
      closeModal('barProductModal');
      
      document.getElementById('inputModalTitle').textContent = `üì¶ ${product.name} miqdori (Max: ${product.stock})`;
      document.getElementById('inputModalValue').placeholder = 'Masalan: 2';
      document.getElementById('inputModalValue').value = '1';
      
      STATE.currentInputType = 'bar-customer';
      
      openModal('inputModal');
      
      const oldConfirm = window.confirmInput;
      window.confirmInput = function() {
        if (STATE.currentInputType !== 'bar-customer') {
            oldConfirm(); 
            return;
        }

        const qty = parseInt(document.getElementById('inputModalValue').value);
        if (isNaN(qty) || qty <= 0 || qty > product.stock) {
          showNotification(`‚ö†Ô∏è To'g'ri miqdor kiriting! (Max: ${product.stock})`);
          return;
        }
        
        const total = product.price * qty;
        
        closeModal('inputModal');
        window.confirmInput = oldConfirm; 
        
        STATE.currentDebtData = { 
            total: total, 
            barItem: product, 
            qty: qty 
        }; 
        STATE.currentTableKey = null; 
        
        document.getElementById('paymentModalHeader').textContent = `Mijozga Sotish`; 
        document.getElementById('paymentDetails').innerHTML = `
            <div style="font-size: 1.2rem; margin-bottom: 10px;"><strong>Mahsulot:</strong> ${product.name} x${qty}</div>
            <div style="font-size: 1.4rem; color: var(--success);"><strong>Jami:</strong> ${total} so'm</div>
        `;
        
        document.getElementById('paymentModalDebtBtn').style.display = 'none'; 
        selectPaymentType('cash', document.getElementById('payBtnCash'));
        openModal('paymentModal');
      };
    }

    function removeBarItem(tableKey, itemIdx) {
      showConfirm('O\'chirishni tasdiqlaysizmi?', () => {
        const item = STATE.tables[tableKey].items[itemIdx];
        const product = STATE.barItems.find(i => i.name === item.name);
        if (product) {
            product.stock += item.quantity; 
        }

        STATE.tables[tableKey].items.splice(itemIdx, 1);
        addLog("Bar (O'chirish)", `${STATE.tables[tableKey].name} - ${item.name} x${item.quantity}`);
        renderPage(getCurrentPage());
        saveData();
        updateActiveSessions();
        updateBarGrid();
        showNotification(`‚úÖ ${item.name} mahsuloti inventarga qaytarildi.`, 1000);
      });
    }

    // ========== DEBTORS & RECEIPTS ==========
    function renderDebtorsPage() {
        const content = document.getElementById('contentArea');
        const debtors = STATE.debtors.filter(d => d.totalDebt > 0);

        content.innerHTML = `
            <h2 style="color:var(--danger);margin-bottom:20px;">üî¥ Qarzdorlar ro'yxati</h2>
            <div class="debtors-list" id="debtorsList">
                ${debtors.length === 0 ? '<div style="text-align:center;color:var(--text-dim);padding:20px;">Hozircha qarzdor yo\'q.</div>' : debtors.map(debtor => `
                    <div class="debtor-card">
                        <div class="debtor-header">
                            <div class="debtor-name">${debtor.name}</div>
                            <div class="debtor-total">${debtor.totalDebt} so'm</div>
                        </div>
                        <div class="debtor-details">
                            ${debtor.debts.map(debt => `
                                <div class="debt-item">
                                    <span>${debt.table} (${debt.duration}) - ${new Date(debt.timestamp).toLocaleDateString()}</span>
                                    <span>${debt.total} so'm</span>
                                </div>
                            `).join('')}
                        </div>
                        <div class="debtor-actions">
                            <button class="btn btn-success" onclick="payDebt('${debtor.name.replace(/'/g, "\\'")}')">üí∞ To'lash</button>
                            <button class="btn btn-danger" onclick="openDeleteDebtorModal('${debtor.name.replace(/'/g, "\\'")}')">‚ùå O'chirish</button>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    }
    
    function payDebt(name) {
      const debtor = STATE.debtors.find(d => d.name === name);
      if (!debtor) return;
      
      STATE.currentDebtorToPay = name;
      
      document.getElementById('payDebtDetails').innerHTML = `
        <div style="background:var(--bg);padding:15px;border-radius:8px;margin-bottom:15px;">
          <div style="margin-bottom:10px;font-size:1.2rem;"><strong>${name}</strong></div>
          <div style="display:flex;justify-content:space-between;margin-top:10px;padding-top:10px;border-top:2px solid var(--danger);">
            <span style="font-size:1.1rem;">Jami qarz:</span>
            <span style="font-size:1.2rem;color:var(--danger);"><strong>${debtor.totalDebt} so'm</strong></span>
          </div>
        </div>
      `;
      
      document.getElementById('payDebtAmount').value = debtor.totalDebt;
      openModal('payDebtModal');
      setTimeout(() => document.getElementById('payDebtAmount').focus(), 300);
    }
    
    function confirmPayDebt(type) {
      const amount = parseInt(document.getElementById('payDebtAmount').value);
      const name = STATE.currentDebtorToPay;
      const debtor = STATE.debtors.find(d => d.name === name);
      
      if (isNaN(amount) || amount <= 0 || amount > debtor.totalDebt) {
        showNotification('‚ö†Ô∏è To\'g\'ri summa kiriting!');
        return;
      }
      
      if (type === 'transfer') {
          STATE.transferBalance += amount;
          document.getElementById('transferCardNumber').textContent = STATE.transferCardNumber;
          document.getElementById('transferAmountDisplay').textContent = amount;
          openModal('transferModal');
      } else {
          STATE.cashBalance += amount;
      }

      const remainingDebt = debtor.totalDebt - amount;
      debtor.totalDebt = remainingDebt;
      
      if (debtor.totalDebt <= 0) {
        STATE.debtors = STATE.debtors.filter(d => d.name !== name);
      }
      
      STATE.debtBalance = STATE.debtors.reduce((sum, d) => sum + d.totalDebt, 0);

      
      addReceipt({
        type: 'debt-payment',
        name: name,
        amount: amount,
        paymentType: type,
        remainingDebt: remainingDebt,
        time: new Date().toLocaleString('uz-UZ'),
        total: amount
      });
      
      addLog("Qarz to'lovi", `${name}: ${amount} so'm (${type})`);
      closeModal('payDebtModal');
      renderDebtorsPage();
      updateUI();
      saveData();
      
      showNotification(`‚úÖ Qarz to'landi: ${amount} so'm (${type.toUpperCase()})`);
    }

    function openDeleteDebtorModal(name) {
        STATE.currentDebtorToDelete = name;
        document.getElementById('deleteDebtorPassword').value = '';
        openModal('deleteDebtorModal');
    }

    function confirmDeleteDebtor() {
        const password = document.getElementById('deleteDebtorPassword').value;
        if (password === STATE.settingsPassword) {
            const debtorName = STATE.currentDebtorToDelete;
            STATE.debtors = STATE.debtors.filter(d => d.name !== debtorName);
            STATE.debtBalance = STATE.debtors.reduce((sum, d) => sum + d.totalDebt, 0); 
            
            addLog("Qarzdor o'chirildi", debtorName);
            closeModal('deleteDebtorModal');
            renderDebtorsPage();
            updateUI();
            saveData();
            showNotification(`‚úÖ Qarzdor (${debtorName}) muvaffaqiyatli o'chirildi!`);
        } else {
            showNotification('‚ùå Noto\'g\'ri parol!');
        }
    }

    function addReceipt(data) {
      STATE.receipts.push({
        ...data,
        timestamp: Date.now(),
        shiftId: STATE.currentShiftId,
        employeeName: STATE.currentUser, 
        id: "receipt-" + Date.now() + Math.random() 
      });
      updateReceipts();
      saveData();
    }

    function updateReceipts() {
      const list = document.getElementById('receiptsList');
      if (!list) return;
      
      const activeFilter = document.querySelector('.receipt-filters .filter-btn.active[data-filter]')?.dataset.filter || 'today';
      const activeType = document.querySelector('.receipt-filters .filter-btn.active[data-type]')?.dataset.type || 'all';
      filterReceipts(activeFilter, document.querySelector(`[data-filter="${activeFilter}"]`), activeType);
    }

    function filterReceipts(filter, activeBtn, type = 'all') {
      document.querySelectorAll('.receipt-filters .filter-btn[data-filter]').forEach(btn => btn.classList.remove('active'));
      if(activeBtn) activeBtn.classList.add('active');
      
      const list = document.getElementById('receiptsList');
      if (!list) return;

      let filteredReceipts = [...STATE.receipts];

      if (filter === 'today') {
          const today = new Date().toLocaleDateString('uz-UZ');
          filteredReceipts = STATE.receipts.filter(r => new Date(r.timestamp).toLocaleDateString('uz-UZ') === today);
      } else if (filter === '7days') {
          const sevenDaysAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
          filteredReceipts = STATE.receipts.filter(r => r.timestamp > sevenDaysAgo);
      } else {
          filteredReceipts = filteredReceipts.slice(-50);
      }
      
      // Tur bo'yicha filtr
      if (type !== 'all') {
        filteredReceipts = filteredReceipts.filter(r => {
          if (type === 'bar') {
            return r.type === 'bar-customer';
          } else {
            return r.table && r.table.toLowerCase().includes(type.toLowerCase());
          }
        });
      }
      
      list.innerHTML = filteredReceipts.reverse().map(r => {
        const paymentType = r.paymentType ? `<span style="font-size:0.8rem;background:${r.paymentType === 'cash' ? '#3b82f6' : (r.paymentType === 'transfer' ? '#f97316' : 'var(--danger)')};padding:3px 8px;border-radius:5px;color:#fff;">${r.paymentType.toUpperCase()}</span>` : '';
        const employee = r.employeeName ? `<div style="font-size:0.8rem;color:var(--text-dim);">Xodim: ${r.employeeName}</div>` : '';
        const printBtn = `<button class="btn-print" onclick="printReceipt('${r.id}')">üñ®Ô∏è Chop etish</button>`;

        if (r.type === 'game') {
          return `
            <div class="receipt-item">
              <div class="receipt-header"><span>${r.table} ${r.vip ? '‚≠ê' : ''}</span> ${paymentType}</div>
              <div class="receipt-row"><span>Boshlanish:</span><span>${r.startTime}</span></div>
              <div class="receipt-row"><span>Davomiyligi:</span><span>${r.duration}</span></div>
              <div class="receipt-row"><span>O'yin:</span><span><strong>${r.gameCost} so'm</strong></span></div>
              ${r.barItems.length > 0 ? `
                <div class="receipt-row"><span>Bar jami:</span><span><strong>${r.barTotal} so'm</strong></span></div>
              ` : ''}
              <div class="receipt-row" style="border-top:1px solid var(--border);padding-top:5px;margin-top:5px;">
                <span><strong>JAMI:</strong></span>
                <span><strong style="color:var(--success);">${r.total} so'm</strong></span>
              </div>
              ${employee}
              <div style="text-align:right; margin-top: 10px;">${printBtn}</div>
            </div>
          `;
        } else if (r.type === 'bar-customer') {
          return `
            <div class="receipt-item">
              <div class="receipt-header"><span>üçπ ${r.item}</span> ${paymentType}</div>
              <div class="receipt-row"><span>Vaqt:</span><span>${r.time}</span></div>
              <div class="receipt-row"><span>Miqdor:</span><span>${r.quantity} x ${r.price}</span></div>
              <div class="receipt-row"><span><strong>JAMI:</strong></span><span><strong>${r.total} so'm</strong></span></div>
              ${employee}
              <div style="text-align:right; margin-top: 10px;">${printBtn}</div>
            </div>
          `;
        } else if (r.type === 'debt-payment') {
            return `
            <div class="receipt-item" style="border-left-color:var(--danger);">
                <div class="receipt-header"><span>üí∏ Qarz to'lovi (${r.name})</span> ${paymentType}</div>
                <div class="receipt-row"><span>Vaqt:</span><span>${r.time}</span></div>
                <div class="receipt-row"><span>To'landi:</span><span><strong>${r.amount} so'm</strong></span></div>
                <div class="receipt-row"><span>Qoldi:</span><span>${r.remainingDebt} so'm</span></div>
                ${employee}
                <div style="text-align:right; margin-top: 10px;">${printBtn}</div>
            </div>
          `;
        } else if (r.type === 'debt-added') {
            return `
            <div class="receipt-item" style="border-left-color:var(--danger);">
                <div class="receipt-header"><span>üî¥ Qarzga yozildi (${r.name})</span></div>
                <div class="receipt-row"><span>Vaqt:</span><span>${r.time}</span></div>
                <div class="receipt-row"><span>Stol:</span><span>${r.table}</span></div>
                <div class="receipt-row"><span><strong>JAMI:</strong></span><span><strong>${r.total} so'm</strong></span></div>
                ${employee}
            </div>
            `;
        } else if (r.type === 'cancelled') {
            return `
            <div class="receipt-item cancelled">
                <div class="receipt-header"><span>‚ùå Bekor qilindi</span></div>
                <div class="receipt-row"><span>Vaqt:</span><span>${r.time}</span></div>
                <div class="receipt-row"><span>Holat:</span><span>${r.details}</span></div>
                ${employee}
            </div>
            `;
        }
        return '';
      }).join('');
    }

    function filterReceiptsByType(type, activeBtn) {
      document.querySelectorAll('.receipt-filters .filter-btn[data-type]').forEach(btn => btn.classList.remove('active'));
      if(activeBtn) activeBtn.classList.add('active');
      
      const activeFilter = document.querySelector('.receipt-filters .filter-btn.active[data-filter]')?.dataset.filter || 'today';
      filterReceipts(activeFilter, document.querySelector(`[data-filter="${activeFilter}"]`), type);
    }

    // ========== HISTORY ==========
    function renderHistoryPage() {
      const content = document.getElementById('contentArea');
      
      content.innerHTML = `
        <h2 style="color:var(--primary);margin-bottom:20px;">üìä Smenalar Tarixi (Oxirgi 7 kun)</h2>
        <div style="max-height:80vh;overflow-y:auto;">
            <table class="data-table">
            <thead>
                <tr>
                <th>Smena</th>
                <th>Xodim</th>
                <th>Boshlanish</th>
                <th>Naqd</th>
                <th>O'tkazma</th>
                <th>Qarz (Jami)</th>
                <th>JAMI TUSHUM</th>
                </tr>
            </thead>
            <tbody>
                ${STATE.history.slice().reverse().map((shift, idx) => `
                <tr>
                    <td>#${STATE.history.length - idx}</td>
                    <td>${shift.employeeName || 'Noma\'lum'}</td>
                    <td>${shift.startTime}</td>
                    <td>${shift.cashBalance} so'm</td>
                    <td>${shift.transferBalance} so'm</td>
                    <td style="color:var(--danger);">${shift.debtBalance} so'm</td>
                    <td><strong style="color:var(--success);">${shift.cashBalance + shift.transferBalance} so'm</strong></td>
                </tr>
                `).join('')}
            </tbody>
            </table>
        </div>
      `;
    }

    // ========== LOG PAGE ==========
    function renderLogPage() {
        const content = document.getElementById('contentArea');
        content.innerHTML = `
            <div style="display:flex; justify-content: space-between; align-items: center;">
                <h2 style="color:var(--primary);margin-bottom:20px;">üìú Harakatlar Jurnali (Log)</h2>
                <button class="btn btn-warning" onclick="openLogExportModal()">Eksport qilish</button>
            </div>
            <div style="max-height:80vh;overflow-y:auto;">
                <table class="data-table">
                <thead>
                    <tr>
                    <th>Vaqt</th>
                    <th>Xodim</th>
                    <th>Harakat</th>
                    <th>Tafsilotlar</th>
                    </tr>
                </thead>
                <tbody>
                    ${STATE.logs.slice().reverse().map(log => `
                    <tr>
                        <td>${log.timestamp}</td>
                        <td>${log.user}</td>
                        <td>${log.action}</td>
                        <td>${log.details}</td>
                    </tr>
                    `).join('')}
                </tbody>
                </table>
            </div>
        `;
    }

    function openLogExportModal() {
        document.getElementById('exportLogPassword').value = '';
        openModal('exportLogPasswordModal');
    }

    function confirmLogExport() {
        const pass = document.getElementById('exportLogPassword').value;
        if (pass !== STATE.settingsPassword) {
            showNotification('‚ùå Noto\'g\'ri parol!', 2000);
            return;
        }
        
        closeModal('exportLogPasswordModal');
        
        let csvContent = "data:text/csv;charset=utf-8,Vaqt,Xodim,Harakat,Tafsilotlar\n";
        STATE.logs.forEach(log => {
            csvContent += `"${log.timestamp}","${log.user}","${log.action}","${log.details}"\n`;
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `noor_log_${new Date().toISOString().slice(0, 10)}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        addLog("Log eksport qilindi", "");
        showNotification('‚úÖ Log fayli muvaffaqiyatli eksport qilindi!', 2000);
    }

    // ========== SETTINGS ==========
    function openSettingsPasswordModal() {
        document.getElementById('settingsPasswordInput').value = '';
        openModal('settingsPasswordModal');
    }

    function checkSettingsPassword() {
        const password = document.getElementById('settingsPasswordInput').value;
        if (password === STATE.settingsPassword) {
            closeModal('settingsPasswordModal');
            openSettingsModal();
        } else {
            showNotification('‚ùå Noto\'g\'ri parol!');
        }
    }

    function openSettingsModal() {
      document.getElementById('settingsPassword').value = '';
      document.getElementById('settingsTransferCard').value = STATE.transferCardNumber;
      
      // Foydalanuvchilarni to'g'ri formatda ko'rsatish
      document.getElementById('usersInput').value = STATE.users.map(u => `${u.username} - ${u.pass}`).join('\n');
      
      document.getElementById('priceB1').value = STATE.prices.b1;
      document.getElementById('priceB2').value = STATE.prices.b2;
      document.getElementById('pricePS4').value = STATE.prices.ps4;
      document.getElementById('pricePS5').value = STATE.prices.ps5;
      document.getElementById('barItemsInput').value = STATE.barItems.map(i => `${i.name} - ${i.price} - ${i.stock}`).join('\n');
      
      // YANGI: FOYDALANUVCHI QO'SHISH FORMASI
      document.getElementById('addUserForm').innerHTML = `
        <h3 style="color:var(--primary);margin-bottom:15px;">‚ûï Yangi Foydalanuvchi Qo'shish</h3>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:10px;align-items:end;">
          <div class="form-group">
            <label>Login</label>
            <input type="text" id="newUserLogin" placeholder="Yangi login">
          </div>
          <div class="form-group">
            <label>Parol</label>
            <input type="password" id="newUserPassword" placeholder="Parol">
          </div>
          <div class="form-group">
            <label>Parolni tasdiqlash</label>
            <input type="password" id="newUserConfirmPassword" placeholder="Parolni qayta kiriting">
          </div>
          <button class="btn btn-success" onclick="addNewUser()" style="height:fit-content;">Qo'shish</button>
        </div>
      `;
      
      openModal('settingsModal');
    }

    // YANGI: FOYDALANUVCHI QO'SHISH FUNKSIYASI
    function addNewUser() {
      const login = document.getElementById('newUserLogin').value.trim();
      const password = document.getElementById('newUserPassword').value;
      const confirmPassword = document.getElementById('newUserConfirmPassword').value;
      
      if (!login || !password) {
        showNotification('‚ö†Ô∏è Login va parolni kiriting!');
        return;
      }
      
      if (password !== confirmPassword) {
        showNotification('‚ùå Parollar mos kelmadi!');
        return;
      }
      
      if (STATE.users.find(u => u.username === login)) {
        showNotification('‚ùå Bu login band!');
        return;
      }
      
      STATE.users.push({ username: login, pass: password });
      
      // Yangilangan foydalanuvchilar ro'yxatini textarea'ga qo'shish
      document.getElementById('usersInput').value = STATE.users.map(u => `${u.username} - ${u.pass}`).join('\n');
      
      document.getElementById('newUserLogin').value = '';
      document.getElementById('newUserPassword').value = '';
      document.getElementById('newUserConfirmPassword').value = '';
      
      addLog("Yangi foydalanuvchi qo'shildi", login);
      saveData(); // Yangi foydalanuvchini darhol saqlash
      showNotification('‚úÖ Yangi foydalanuvchi qo\'shildi! Sozlamalarni saqlashni unutmang!');
    }

    function saveSettings() {
      const newSettingsPassword = document.getElementById('settingsPassword').value.trim();
      if (newSettingsPassword) {
        STATE.settingsPassword = newSettingsPassword;
        localStorage.setItem('noorSettingsPassword', encrypt(newSettingsPassword));
      }
      
      const newTransferCard = document.getElementById('settingsTransferCard').value.trim();
      STATE.transferCardNumber = newTransferCard;
      localStorage.setItem('noorTransferCard', encrypt(newTransferCard));

      // Foydalanuvchilarni textarea'dan yangilash
      const usersText = document.getElementById('usersInput').value;
      STATE.users = usersText.split('\n').filter(l => l.trim()).map(line => {
        const parts = line.split('-').map(s => s.trim());
        return { username: parts[0], pass: parts[1] || "" };
      }).filter(u => u.username && u.pass);

      
      STATE.prices.b1 = parseInt(document.getElementById('priceB1').value) || DEFAULT_STATE.prices.b1;
      STATE.prices.b2 = parseInt(document.getElementById('priceB2').value) || DEFAULT_STATE.prices.b2;
      STATE.prices.ps4 = parseInt(document.getElementById('pricePS4').value) || DEFAULT_STATE.prices.ps4;
      STATE.prices.ps5 = parseInt(document.getElementById('pricePS5').value) || DEFAULT_STATE.prices.ps5;
      
      const barText = document.getElementById('barItemsInput').value;
      STATE.barItems = barText.split('\n').filter(l => l.trim()).map(line => {
        const parts = line.split('-').map(s => s.trim());
        const name = parts[0];
        const price = parseInt(parts[1]) || 0;
        const stock = parseInt(parts[2]) || 0;
        return { name: name, price: price, stock: stock };
      }).filter(i => i.price > 0 && i.name);
      
      addLog("Sozlamalar o'zgartirildi", "Foydalanuvchilar va narxlar");
      saveData();
      closeModal('settingsModal');
      showNotification('‚úÖ Sozlamalar saqlandi! Foydalanuvchilar yangilandi.');
      
      if (getCurrentPage() === 'bar') renderBarPage();
      renderPage(getCurrentPage()); 
    }

    // ========== UI UPDATE ==========
    function updateUI() {
      STATE.debtBalance = STATE.debtors.reduce((sum, d) => sum + d.totalDebt, 0);

      document.getElementById('cashBalance').textContent = `${STATE.cashBalance} so'm`;
      document.getElementById('transferBalance').textContent = `${STATE.transferBalance} so'm`;
      document.getElementById('debtBalance').textContent = `${STATE.debtBalance} so'm`;
      
      document.getElementById('statB1').textContent = `${STATE.stats.b1} so'm`;
      document.getElementById('statB2').textContent = `${STATE.stats.b2} so'm`;
      document.getElementById('statPS4').textContent = `${STATE.stats.ps4} so'm`;
      document.getElementById('statPS5').textContent = `${STATE.stats.ps5} so'm`;
      document.getElementById('statBar').textContent = `${STATE.stats.bar} so'm`;
      
      const total = STATE.stats.b1 + STATE.stats.b2 + STATE.stats.ps4 + STATE.stats.ps5 + STATE.stats.bar;
      document.getElementById('statTotal').textContent = `${total} so'm`;
      
      document.getElementById('notesArea').value = STATE.notes;
      updateReceipts();
      updateActiveSessions();
      updateTopDebtors();

      if (STATE.shiftOpen) {
        document.getElementById('shiftStatus').textContent = `Smena ochiq (${STATE.currentUser})`;
        document.getElementById('shiftStatus').classList.add('open');
        document.getElementById('shiftBtn').textContent = 'Smena yopish';
      } else {
        document.getElementById('shiftStatus').textContent = 'Smena yopiq';
        document.getElementById('shiftStatus').classList.remove('open');
        document.getElementById('shiftBtn').textContent = 'Smena ochish';
      }
    }
    
    function updateActiveSessions() {
      const container = document.getElementById('activeSessions');
      if (!container) return;
      
      let totalRevenue = 0;
      const activeTables = Object.keys(STATE.tables).filter(key => STATE.tables[key].active);
      
      if (activeTables.length === 0) {
        container.innerHTML = '<div style="text-align:center;color:var(--text-dim);">Faol sessiya yo\'q</div>';
        return;
      }
      
      container.innerHTML = activeTables.map(key => {
        const table = STATE.tables[key];
        
        const gameCost = calculateCost(key); 
        const barTotal = table.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const revenue = gameCost + barTotal;
        totalRevenue += revenue;
        
        return `
          <div class="session-row">
            <span>${table.name} ${table.vip ? '‚≠ê' : ''} ${!table.running ? '(Pauzada)' : ''}</span>
            <span style="color:var(--success);font-weight:800;">${revenue} so'm</span>
          </div>
        `;
      }).join('') + `
        <div class="session-row" style="border-top:2px solid var(--primary);padding-top:8px;margin-top:8px;">
          <span style="font-weight:800;">Jami:</span>
          <span style="color:var(--success);font-weight:800;font-size:1.1rem;">${totalRevenue} so'm</span>
        </div>
      `;
    }
    
    function updateTopDebtors() {
      const container = document.getElementById('topDebtorsList');
      if (!container) return;
      
      const sorted = [...STATE.debtors].filter(d => d.totalDebt > 0).sort((a, b) => b.totalDebt - a.totalDebt).slice(0, 10);
      
      if (sorted.length === 0) {
        container.innerHTML = '<div style="text-align:center;color:var(--text-dim);">Qarzdor yo\'q</div>';
        return;
      }
      
      container.innerHTML = sorted.map((debtor, idx) => `
        <div class="debtor-row">
          <span>${idx + 1}. ${debtor.name}</span>
          <span style="font-weight:800;">${debtor.totalDebt} so'm</span>
        </div>
      `).join('');
    }

    // ========== HELPERS ==========
    function formatTime(totalSeconds) {
      if (totalSeconds < 0) totalSeconds = 0;
      const mins = Math.floor(totalSeconds / 60);
      const secs = totalSeconds % 60;
      return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
    }

    function saveNotes() {
        STATE.notes = document.getElementById('notesArea').value;
        addLog("Zametka o'zgartirildi", "");
        saveData();
        showNotification('üìù Eslatmalar saqlandi!', 1000);
    }
    
    function printReceipt(receiptId) {
        const receipt = STATE.receipts.find(r => r.id === receiptId);
        if (!receipt) {
            showNotification('‚ùå Chek topilmadi!', 2000);
            return;
        }

        let receiptHTML = `
            <style>
                body { font-family: 'Arial', sans-serif; margin: 20px; color: #000; }
                .print-container { width: 300px; margin: 0 auto; }
                h2 { text-align: center; margin-bottom: 10px; }
                .row { display: flex; justify-content: space-between; margin-bottom: 5px; padding-bottom: 5px; border-bottom: 1px dashed #999; }
                .row span:first-child { font-weight: bold; }
                .total { font-size: 1.2rem; font-weight: bold; margin-top: 10px; }
                .bar-items { margin-left: 15px; font-size: 0.9rem; }
            </style>
            <div class="print-container">
                <h2>NOOR Club</h2>
                <div class="row">
                    <span>Xodim:</span>
                    <span>${receipt.employeeName || 'N/A'}</span>
                </div>
        `;

        const paymentTypeMap = {
            'cash': "Naqd",
            'transfer': "O'tkazma"
        };
        const paymentType = paymentTypeMap[receipt.paymentType] || 'N/A';

        if (receipt.type === 'game') {
            receiptHTML += `
                <div class="row">
                    <span>Stol:</span>
                    <span>${receipt.table} ${receipt.vip ? '‚≠ê' : ''}</span>
                </div>
                <div class="row">
                    <span>Boshlanish:</span>
                    <span>${receipt.startTime}</span>
                </div>
                <div class="row">
                    <span>Davomiyligi:</span>
                    <span>${receipt.duration}</span>
                </div>
                <div class="row">
                    <span>O'yin narxi:</span>
                    <span>${receipt.gameCost} so'm</span>
                </div>
            `;
            if (receipt.barItems.length > 0) {
                receiptHTML += `<div class="row"><span>Bar:</span><span></span></div>`;
                                receiptHTML += `<div class="row"><span>Bar:</span><span></span></div>`;
                receipt.barItems.forEach(item => {
                    receiptHTML += `
                        <div class="row bar-items">
                            <span>${item.name} x${item.quantity}</span>
                            <span>${item.price * item.quantity} so'm</span>
                        </div>
                    `;
                });
                receiptHTML += `
                    <div class="row">
                        <span>Bar jami:</span>
                        <span>${receipt.barTotal} so'm</span>
                    </div>
                `;
            }
        } else if (receipt.type === 'bar-customer') {
            receiptHTML += `
                <div class="row">
                    <span>Sotuv:</span>
                    <span>Mijozga (Bar)</span>
                </div>
                <div class="row">
                    <span>Vaqt:</span>
                    <span>${receipt.time}</span>
                </div>
                <div class="row">
                    <span>Mahsulot:</span>
                    <span>${receipt.item} x${receipt.quantity}</span>
                </div>
            `;
        } else if (receipt.type === 'debt-payment') {
            receiptHTML += `
                <div class="row">
                    <span>To'lov:</span>
                    <span>Qarz to'lovi</span>
                </div>
                <div class="row">
                    <span>Qarzdor:</span>
                    <span>${receipt.name}</span>
                </div>
                 <div class="row">
                    <span>To'landi:</span>
                    <span>${receipt.amount} so'm</span>
                </div>
                <div class="row">
                    <span>Qoldiq:</span>
                    <span>${receipt.remainingDebt} so'm</span>
                </div>
            `;
        } else if (receipt.type === 'debt-added') {
            receiptHTML += `
                <div class="row">
                    <span>Holat:</span>
                    <span>Qarzga yozildi</span>
                </div>
                 <div class="row">
                    <span>Qarzdor:</span>
                    <span>${receipt.name}</span>
                </div>
                <div class="row">
                    <span>Stol:</span>
                    <span>${receipt.table}</span>
                </div>
            `;
        } else if (receipt.type === 'cancelled') {
             receiptHTML += `
                <div class="row">
                    <span>Holat:</span>
                    <span>Bekor Qilindi</span>
                </div>
                 <div class="row">
                    <span>Vaqt:</span>
                    <span>${receipt.time}</span>
                </div>
                <div class="row">
                    <span>Obyekt:</span>
                    <span>${receipt.details}</span>
                </div>
            `;
        }

        if (receipt.type !== 'cancelled' && receipt.type !== 'debt-added') {
             receiptHTML += `
                <div class="row total">
                    <span>JAMI:</span>
                    <span>${receipt.total} so'm</span>
                </div>
                <div class="row">
                    <span>To'lov usuli:</span>
                    <span>${paymentType}</span>
                </div>
            `;
        }

        receiptHTML += `
            <div style="text-align:center; margin-top: 20px; font-size: 0.8rem;">
                Chek: ${receipt.id.slice(0, 10)}...<br>
                ${new Date(receipt.timestamp).toLocaleString('uz-UZ')}
            </div>
            </div>
        `;

        const printWindow = window.open('', '', 'height=600,width=400');
        printWindow.document.write(receiptHTML);
        printWindow.document.close();
        printWindow.focus();
        printWindow.print();
    }

    // ========== INIT ==========
    initializeDatabase();
    initializePasswords();
    checkSeasonalFeatures();
    setInterval(updateClock, 1000);
    setInterval(updateActiveSessions, 5000); 
    setInterval(saveData, 30000);
    setInterval(checkSessionTimeout, 60000); // Har 1 daqiqa session timeout ni tekshirish
    setInterval(cleanOldHistory, 24 * 60 * 60 * 1000);
    setInterval(cleanOldReceipts, 24 * 60 * 60 * 1000);
    setInterval(cleanOldLogs, 24 * 60 * 60 * 1000);
    updateClock();
  </script>
</body>
</html>